<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NIST CSF 2.0 â€“ Questionnaire</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
    </style>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- ðŸ”§ Recharts UMD : charge via plusieurs CDN avec repli -->
    <script>
      (function loadRechartsWithFallback() {
        const CDN_SOURCES = [
          "https://cdn.jsdelivr.net/npm/recharts@2.10.0/umd/Recharts.min.js",
          "https://unpkg.com/recharts@2.10.0/umd/Recharts.min.js",
          "https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.0/Recharts.min.js",
        ];

        const callbacks = [];
        let status = "idle"; // idle | loading | ready | failed

        function notify(err) {
          if (status === "ready") {
            callbacks.splice(0).forEach((cb) => cb(null, window.Recharts));
          } else if (status === "failed") {
            const error =
              err || new Error("Impossible de charger Recharts depuis les CDN disponibles.");
            callbacks.splice(0).forEach((cb) => cb(error));
          }
        }

        function attempt(index) {
          if (index >= CDN_SOURCES.length) {
            status = "failed";
            notify();
            return;
          }

          status = "loading";
          const script = document.createElement("script");
          script.src = CDN_SOURCES[index];
          script.async = true;
          script.crossOrigin = "anonymous";
          script.onload = () => {
            if (window.Recharts && typeof window.Recharts === "object") {
              status = "ready";
              notify();
            } else {
              script.remove();
              attempt(index + 1);
            }
          };
          script.onerror = () => {
            script.remove();
            attempt(index + 1);
          };
          document.head.appendChild(script);
        }

        window.onRechartsReady = function onRechartsReady(callback) {
          if (typeof callback !== "function") return;
          if (status === "ready") {
            callback(null, window.Recharts);
            return;
          }
          if (status === "failed") {
            callback(new Error("Recharts n'a pas pu Ãªtre chargÃ©."));
            return;
          }
          callbacks.push(callback);
        };

        attempt(0);
      })();
    </script>

    <!-- htm (JSX-like) -->
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  </head>
  <body class="bg-neutral-50">
    <div id="root"></div>

    <script>
      const { useEffect, useMemo, useState } = React;
      const html = window.htm.bind(React.createElement);

      function renderError(message) {
        const root = document.getElementById("root");
        if (!root) return;
        root.innerHTML = `
          <div class="max-w-3xl mx-auto mt-16 p-6 rounded-lg border border-red-200 bg-red-50 text-red-900">
            <h1 class="text-xl font-semibold mb-2">Erreur de chargement</h1>
            <p class="mb-3">${message}</p>
            <p class="text-sm text-red-800">
              VÃ©rifiez votre connexion Internet ou autorisez l'accÃ¨s aux CDN suivants :
              <code>cdn.jsdelivr.net</code>, <code>unpkg.com</code>, <code>cdnjs.cloudflare.com</code>.
            </p>
          </div>
        `;
      }

      function bootstrap(Recharts) {
        if (!Recharts) {
          renderError("Recharts n'est pas disponible â€“ chargement interrompu.");
          return;
        }

        const {
          BarChart,
          Bar,
          XAxis,
          YAxis,
          CartesianGrid,
          Tooltip,
          ResponsiveContainer,
          Radar: RadarShape,
          RadarChart: RChart,
          PolarGrid,
          PolarAngleAxis,
          PolarRadiusAxis,
          Legend,
          Cell,
          ReferenceLine,
        } = Recharts;

      /**
       * NIST CSF 2.0 â€“ Web Questionnaire (React + htm, sans build)
       */

      // ----------------------------- Utils -----------------------------
      function avg(values) {
        const nums = (values || []).filter(
          (v) => typeof v === "number" && !Number.isNaN(v)
        );
        if (!nums.length) return 0;
        return nums.reduce((a, b) => a + b, 0) / nums.length;
      }

      function escapeCSV(v) {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes("\n") || s.includes('"')) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }

      const PALETTE = [
        "#2563EB",
        "#EA580C",
        "#16A34A",
        "#9333EA",
        "#DC2626",
        "#0891B2",
        "#CA8A04",
        "#0D9488",
        "#7C3AED",
        "#BE185D",
        "#4F46E5",
        "#065F46",
      ];
      function hashString(str = "") {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
          h = (h << 5) - h + str.charCodeAt(i);
          h |= 0;
        }
        return Math.abs(h);
      }
      function categoryColor(name) {
        if (!name) return "#111827";
        const idx = hashString(name) % PALETTE.length;
        return PALETTE[idx];
      }

      const FUNCTION_COLORS = {
        GOVERN: "#1E3A8A",
        IDENTIFY: "#2563EB",
        PROTECT: "#059669",
        DETECT: "#9333EA",
        RESPOND: "#DC2626",
        RECOVER: "#EA580C",
      };
      function functionColor(fn) {
        return FUNCTION_COLORS[fn] || "#111827";
      }

      const FUNCTION_LABELS = {
        GOVERN: { fr: "Gouverner", en: "Govern" },
        IDENTIFY: { fr: "Identifier", en: "Identify" },
        PROTECT: { fr: "ProtÃ©ger", en: "Protect" },
        DETECT: { fr: "DÃ©tecter", en: "Detect" },
        RESPOND: { fr: "RÃ©pondre", en: "Respond" },
        RECOVER: { fr: "RÃ©tablir", en: "Recover" },
      };

      // ----------------------------- i18n -----------------------------
      const I18N = {
        fr: {
          appTitle: "NIST CSF 2.0 â€“ Questionnaire dâ€™Ã©valuation",
          exportCSV: "Export CSV",
          exportJSON: "Export JSON",
          importJSON: "Import JSON",
          maturityScore: "Score de maturitÃ©",
          maturityAvgHint: "Moyenne de toutes les questions notÃ©es",
          maturityByFn: "MaturitÃ© par Function",
          radarTitle: "Actuel vs Cible (par Function)",
          catTitle:
            "MaturitÃ© par CatÃ©gorie (moyenne des questions renseignÃ©es)",
          noDataYet:
            "Aucune donnÃ©e encore â€” commence Ã  noter des questions pour alimenter le dashboard.",
          targetLegend: "Cible (pointillÃ©s)",
          meta: "MÃ©tadonnÃ©es",
          project: "Projet",
          assessor: "Ã‰valuateur",
          org: "Organisation",
          date: "Date",
          quickFilter: "Filtre rapide",
          fnLabel: "Fonction",
          catLabel: "CatÃ©gorie",
          search: "Recherche",
          searchPh: "ID, texte, catÃ©gorie...",
          targets: "Cibles par Function",
          questions: "Questions",
          display: "Affichage",
          cmmiPlaceholder: "Notation CMMIâ€¦",
          commentsPh: "Commentaires, preuves, risques, actionsâ€¦",
          tips1: "ðŸ’¾ Sauvegarde automatique activÃ©e (navigateur localStorage).",
          tips2:
            "ðŸ“¤ Utilisez Export JSON/CSV pour partager ou analyser vos rÃ©sultats.",
          tips3:
            "ðŸ–¨ï¸ Astuce impression: Ctrl/Cmd+P â†’ Imprimer en PDF (format A4/Lettre).",
          globalLang: "Langue",
          globalToggleHint: "Basculer FR/EN pour tout le site",
          moreInfo: "Plus dâ€™info",
          descFull: "Description complÃ¨te",
          people: "People (rÃ´les responsables)",
          process: "Processus attendus",
          technology: "Technologie (exemples)",
        },
        en: {
          appTitle: "NIST CSF 2.0 â€“ Assessment Questionnaire",
          exportCSV: "Export CSV",
          exportJSON: "Export JSON",
          importJSON: "Import JSON",
          maturityScore: "Maturity Score",
          maturityAvgHint: "Average of all answered questions",
          maturityByFn: "Maturity by Function",
          radarTitle: "Current vs Target (by Function)",
          catTitle:
            "Maturity by Category (average of answered questions)",
          noDataYet:
            "No data yet â€” start rating questions to feed the dashboard.",
          targetLegend: "Target (dotted)",
          meta: "Metadata",
          project: "Project",
          assessor: "Assessor",
          org: "Organization",
          date: "Date",
          quickFilter: "Quick Filter",
          fnLabel: "Function",
          catLabel: "Category",
          search: "Search",
          searchPh: "ID, text, category...",
          targets: "Targets by Function",
          questions: "Questions",
          display: "Display",
          cmmiPlaceholder: "CMMI ratingâ€¦",
          commentsPh: "Comments, evidence, risks, actionsâ€¦",
          tips1: "ðŸ’¾ Autosave enabled (browser localStorage).",
          tips2: "ðŸ“¤ Use Export JSON/CSV to share or analyze your results.",
          tips3: "ðŸ–¨ï¸ Print tip: Ctrl/Cmd+P â†’ Print to PDF (A4/Letter).",
          globalLang: "Language",
          globalToggleHint: "Toggle FR/EN across the site",
          moreInfo: "More info",
          descFull: "Full description",
          people: "People (responsible roles)",
          process: "Expected processes",
          technology: "Technology (examples)",
        },
      };

      function AngleTick(props) {
        const { x, y, payload, textAnchor } = props;
        const color = functionColor(payload?.value);
        return html`<text
          x=${x}
          y=${y}
          textAnchor=${textAnchor || "middle"}
          fill=${color}
          fontSize=${11}
        >
          ${payload?.value}
        </text>`;
      }

      // ... ðŸ’¡ tout le reste de ton script (Card, TextField, NistCsfQuestionnaire, etc.)
      // NE CHANGE PAS : je nâ€™ai pas modifiÃ© la logique de lâ€™app, seulement le chargement Recharts.

      // (Garde exactement ton gros bloc JS que tu avais aprÃ¨s AngleTick)
      // et Ã  la fin :

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(html`<${NistCsfQuestionnaire} />`);
      }

      if (typeof window.onRechartsReady === "function") {
        window.onRechartsReady((err, lib) => {
          if (err) {
            console.error(err);
            renderError(
              "Impossible de charger Recharts depuis les CDN configurÃ©s. Veuillez rÃ©essayer plus tard."
            );
            return;
          }
          bootstrap(lib);
        });
      } else {
        bootstrap(window.Recharts);
      }
    </script>
  </body>
</html>
