<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NIST CSF 2.0 â€“ Questionnaire</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
    </style>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.0/umd/Recharts.min.js" crossorigin></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  </head>
  <body class="bg-neutral-50">
    <div id="root"></div>
    <script>
      const { useEffect, useMemo, useState } = React;
      const html = window.htm.bind(React.createElement);
      const {
        BarChart,
        Bar,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ResponsiveContainer,
        Radar: RadarShape,
        RadarChart: RChart,
        PolarGrid,
        PolarAngleAxis,
        PolarRadiusAxis,
        Legend,
        Cell,
        ReferenceLine,
      } = Recharts;

      /**
       * NIST CSF 2.0 â€“ Web Questionnaire (React single-file component)
       */

      // ----------------------------- Utils -----------------------------
      function avg(values) {
        const nums = (values || []).filter(
          (v) => typeof v === "number" && !Number.isNaN(v)
        );
        if (!nums.length) return 0;
        return nums.reduce((a, b) => a + b, 0) / nums.length;
      }

      function escapeCSV(v) {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes("\n") || s.includes("\"")) {
          return "\"" + s.replace(/\"/g, "\"\"") + "\"";
        }
        return s;
      }

      const PALETTE = [
        "#2563EB", // blue-600
        "#EA580C", // orange-600
        "#16A34A", // green-600
        "#9333EA", // purple-600
        "#DC2626", // red-600
        "#0891B2", // cyan-600
        "#CA8A04", // yellow-600
        "#0D9488", // teal-600
        "#7C3AED", // violet-600
        "#BE185D", // pink-700
        "#4F46E5", // indigo-600
        "#065F46", // emerald-800
      ];
      function hashString(str = "") {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
          h = (h << 5) - h + str.charCodeAt(i);
          h |= 0;
        }
        return Math.abs(h);
      }
      function categoryColor(name) {
        if (!name) return "#111827";
        const idx = hashString(name) % PALETTE.length;
        return PALETTE[idx];
      }

      const FUNCTION_COLORS = {
        GOVERN: "#1E3A8A",
        IDENTIFY: "#2563EB",
        PROTECT: "#059669",
        DETECT: "#9333EA",
        RESPOND: "#DC2626",
        RECOVER: "#EA580C",
      };
      function functionColor(fn) {
        return FUNCTION_COLORS[fn] || "#111827";
      }

      // Labels for ribbon & UI
      const FUNCTION_LABELS = {
        GOVERN: { fr: "Gouverner", en: "Govern" },
        IDENTIFY: { fr: "Identifier", en: "Identify" },
        PROTECT: { fr: "ProtÃ©ger", en: "Protect" },
        DETECT: { fr: "DÃ©tecter", en: "Detect" },
        RESPOND: { fr: "RÃ©pondre", en: "Respond" },
        RECOVER: { fr: "RÃ©tablir", en: "Recover" },
      };

      // ----------------------------- i18n -----------------------------
      const I18N = {
        fr: {
          appTitle: "NIST CSF 2.0 â€“ Questionnaire dâ€™Ã©valuation",
          exportCSV: "Export CSV",
          exportJSON: "Export JSON",
          importJSON: "Import JSON",
          maturityScore: "Score de maturitÃ©",
          maturityAvgHint: "Moyenne de toutes les questions notÃ©es",
          maturityByFn: "MaturitÃ© par Function",
          radarTitle: "Actuel vs Cible (par Function)",
          catTitle:
            "MaturitÃ© par CatÃ©gorie (moyenne des questions renseignÃ©es)",
          noDataYet:
            "Aucune donnÃ©e encore â€” commence Ã  noter des questions pour alimenter le dashboard.",
          targetLegend: "Cible (pointillÃ©s)",
          meta: "MÃ©tadonnÃ©es",
          project: "Projet",
          assessor: "Ã‰valuateur",
          org: "Organisation",
          date: "Date",
          quickFilter: "Filtre rapide",
          fnLabel: "Fonction",
          catLabel: "CatÃ©gorie",
          search: "Recherche",
          searchPh: "ID, texte, catÃ©gorie...",
          targets: "Cibles par Function",
          questions: "Questions",
          display: "Affichage",
          cmmiPlaceholder: "Notation CMMIâ€¦",
          commentsPh: "Commentaires, preuves, risques, actionsâ€¦",
          tips1: "ðŸ’¾ Sauvegarde automatique activÃ©e (navigateur localStorage).",
          tips2:
            "ðŸ“¤ Utilisez Export JSON/CSV pour partager ou analyser vos rÃ©sultats.",
          tips3:
            "ðŸ–¨ï¸ Astuce impression: Ctrl/Cmd+P â†’ Imprimer en PDF (format A4/Lettre).",
          globalLang: "Langue",
          globalToggleHint: "Basculer FR/EN pour tout le site",
          moreInfo: "Plus dâ€™info",
          descFull: "Description complÃ¨te",
          people: "People (rÃ´les responsables)",
          process: "Processus attendus",
          technology: "Technologie (exemples)",
        },
        en: {
          appTitle: "NIST CSF 2.0 â€“ Assessment Questionnaire",
          exportCSV: "Export CSV",
          exportJSON: "Export JSON",
          importJSON: "Import JSON",
          maturityScore: "Maturity Score",
          maturityAvgHint: "Average of all answered questions",
          maturityByFn: "Maturity by Function",
          radarTitle: "Current vs Target (by Function)",
          catTitle:
            "Maturity by Category (average of answered questions)",
          noDataYet:
            "No data yet â€” start rating questions to feed the dashboard.",
          targetLegend: "Target (dotted)",
          meta: "Metadata",
          project: "Project",
          assessor: "Assessor",
          org: "Organization",
          date: "Date",
          quickFilter: "Quick Filter",
          fnLabel: "Function",
          catLabel: "Category",
          search: "Search",
          searchPh: "ID, text, category...",
          targets: "Targets by Function",
          questions: "Questions",
          display: "Display",
          cmmiPlaceholder: "CMMI ratingâ€¦",
          commentsPh: "Comments, evidence, risks, actionsâ€¦",
          tips1: "ðŸ’¾ Autosave enabled (browser localStorage).",
          tips2: "ðŸ“¤ Use Export JSON/CSV to share or analyze your results.",
          tips3: "ðŸ–¨ï¸ Print tip: Ctrl/Cmd+P â†’ Print to PDF (A4/Letter).",
          globalLang: "Language",
          globalToggleHint: "Toggle FR/EN across the site",
          moreInfo: "More info",
          descFull: "Full description",
          people: "People (responsible roles)",
          process: "Expected processes",
          technology: "Technology (examples)",
        },
      };

      function AngleTick(props) {
        const { x, y, payload, textAnchor } = props;
        const color = functionColor(payload?.value);
        return html`
          <text x=${x} y=${y} textAnchor=${textAnchor || "middle"} fill=${color} fontSize=${11}>
            ${payload?.value}
          </text>
        `;
      }

      // ----------------------------- UI helpers BEFORE usage -----------------------------
      function Card({ title, children }) {
        return html`
          <div class="rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm">
            ${title && html`<div class="font-medium mb-3">${title}</div>`}
            ${children}
          </div>
        `;
      }

      function TextField({
        label,
        value,
        onChange,
        type = "text",
        placeholder,
      }) {
        return html`
          <label class="grid gap-1 w-full">
            <span class="text-sm text-neutral-600">${label}</span>
            <input
              type=${type}
              class="px-3 py-2 rounded-xl border border-neutral-300 w-full"
              value=${value ?? ""}
              placeholder=${placeholder ?? ""}
              onChange=${(e) => onChange(e.target.value)}
            />
          </label>
        `;
      }

      function Select({ label, value, onChange, options }) {
        return html`
          <label class="grid gap-1">
            <span class="text-sm text-neutral-600">${label}</span>
            <select
              class="px-3 py-2 rounded-xl border border-neutral-300"
              value=${value}
              onChange=${(e) => onChange(e.target.value)}
            >
              ${options.map(
                (o) => html`<option key=${o} value=${o}>${o}</option>`
              )}
            </select>
          </label>
        `;
      }

      function ProgressPill({ label, done, total, onClick }) {
        const pct = total > 0 ? Math.round((done / total) * 100) : 0;
        return html`
          <button
            onClick=${onClick}
            class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-neutral-200 bg-white shadow-sm"
          >
            <span class="text-xs font-medium">${label}</span>
            <span class="text-xs text-neutral-500">
              ${done}/${total} Â· ${pct}%
            </span>
          </button>
        `;
      }

      function SectionHeader({ title, subtitle }) {
        return html`
          <div class="mb-3">
            <div class="text-lg font-semibold">${title}</div>
            ${
              subtitle &&
              html`<div class="text-sm text-neutral-600">${subtitle}</div>`
            }
          </div>
        `;
      }

      // Self-tests (run after helpers exist)
      function runSelfTests() {
        try {
          console.assert(avg([1, 2, 3]) === 2, "avg([1,2,3]) should be 2");
          console.assert(
            avg([undefined, 3, null, 5]) === 4,
            "avg ignores non-numbers"
          );
          console.assert(avg([]) === 0, "avg([]) is 0");
          console.assert(
            escapeCSV('a"b') === '"a""b"',
            "CSV quotes doubled"
          );
          console.assert(
            categoryColor("Asset") === categoryColor("Asset"),
            "color stable"
          );
          console.assert(
            typeof TextField === "function",
            "TextField helper must exist"
          );
          console.assert(
            typeof Card === "function",
            "Card helper must exist"
          );
          console.assert(
            typeof I18N.fr.appTitle === "string" && typeof I18N.en.appTitle === "string",
            "i18n sanity"
          );
        } catch (e) {
          console.warn("Self-tests failed:", e);
        }
      }
      if (typeof window !== "undefined") runSelfTests();

      // ----------------------------- Data -----------------------------
      const CMMI_SCALE = [
        { value: 0, label: "0 â€“ Incomplet / Non amorcÃ©" },
        { value: 1, label: "1 â€“ Initial / Ad hoc" },
        { value: 2, label: "2 â€“ GÃ©rÃ©" },
        { value: 3, label: "3 â€“ DÃ©fini" },
        { value: 4, label: "4 â€“ Quantitativement gÃ©rÃ©" },
        { value: 5, label: "5 â€“ OptimisÃ©" },
      ];

      function getFunctionLabel(fn, lang) {
        const entry = FUNCTION_LABELS[fn];
        if (!entry) return fn;
        return lang === "fr" ? entry.fr : entry.en;
      }

      const detailsById = {
        "GOV-RM.01": {
          fr: {
            desc: "La stratÃ©gie de gestion des risques cyber dÃ©finit lâ€™appÃ©tence au risque, les objectifs, le pÃ©rimÃ¨tre (IT/OT/Cloud/SaaS), les responsabilitÃ©s et la gouvernance (comitÃ©, indicateurs, revues). Elle sâ€™aligne sur les objectifs dâ€™affaires et sâ€™intÃ¨gre au cadre ERM.",
            people: [
              "ComitÃ© de gouvernance (ex. ComitÃ© Risques)",
              "CISO / RSSI",
              "PropriÃ©taires de risques (mÃ©tier et IT)",
              "CIO / CTO",
              "Direction gÃ©nÃ©rale / Conseil dâ€™administration",
              "Audit Interne / ConformitÃ©",
            ],
            process: [
              "DÃ©finition dâ€™appÃ©tence/tolÃ©rance au risque (statements)",
              "MÃ©thodologie dâ€™Ã©valuation (ISO 31000 / NIST CSF-aligned)",
              "Registre des risques et des plans de traitement",
              "KRIs/KPIs et tableau de bord de suivi",
              "Cycle de revue (trimestriel) et escalade",
              "Gestion des exceptions et dÃ©rogations",
              "IntÃ©gration chaÃ®ne dâ€™approvisionnement (TPRM)",
            ],
            tech: [
              "ServiceNow GRC / Risk",
              "Archer / RSA GRC",
              "OneTrust GRC",
              "Atlassian Jira + Confluence (risks register)",
              "MetricStream / LogicGate",
            ],
          },
          en: {
            desc: "The cyber risk management strategy defines risk appetite, objectives, scope (IT/OT/Cloud/SaaS), roles and governance (committee, metrics, reviews). It aligns with business goals and integrates with Enterprise Risk Management (ERM).",
            people: [
              "Risk Governance Committee",
              "CISO",
              "Risk Owners (business & IT)",
              "CIO / CTO",
              "Executive Leadership / Board",
              "Internal Audit / Compliance",
            ],
            process: [
              "Risk appetite/tolerance statements",
              "Assessment methodology (ISO 31000 / NIST CSF-aligned)",
              "Risk register and treatment plans",
              "KRIs/KPIs and dashboard",
              "Periodic review cycle (e.g., quarterly) and escalation",
              "Exception/waiver management",
              "Supply chain integration (TPRM)",
            ],
            tech: [
              "ServiceNow GRC / Risk",
              "Archer / RSA GRC",
              "OneTrust GRC",
              "Atlassian Jira + Confluence (risk register)",
              "MetricStream / LogicGate",
            ],
          },
        },
      };

      const controls = [
        {
          id: "GOV-RM.01",
          function: "GOVERN",
          category: "Risk Management Strategy",
          text: {
            fr: "Votre organisation dispose-t-elle dâ€™une stratÃ©gie claire de gestion des risques cyber, alignÃ©e sur les objectifs dâ€™affaires et connue des principales parties prenantes ?",
            en: "Does your organization have a clear cyber risk management strategy aligned with business objectives and known by key stakeholders?",
          },
        },
        {
          id: "GOV-PO.02",
          function: "GOVERN",
          category: "Policy & Oversight",
          text: {
            fr: "Les rÃ´les et responsabilitÃ©s en cybersÃ©curitÃ© sont-ils bien dÃ©finis, compris et suivis (comitÃ©, RACI, indicateurs) ?",
            en: "Are cybersecurity roles and responsibilities well defined, understood, and monitored (e.g., committee, RACI, KPIs)?",
          },
        },
        {
          id: "ID-AM.01",
          function: "IDENTIFY",
          category: "Asset Management",
          text: {
            fr: "Disposez-vous dâ€™un inventaire complet et Ã  jour de vos actifs (IT, OT, SaaS, Cloud) avec propriÃ©taires, criticitÃ© et dÃ©pendances ?",
            en: "Do you maintain a complete, up-to-date inventory of assets (IT, OT, SaaS, Cloud) with owners, criticality, and dependencies?",
          },
        },
        {
          id: "ID-SC.02",
          function: "IDENTIFY",
          category: "Supply Chain",
          text: {
            fr: "La gestion des risques fournisseurs couvre-t-elle lâ€™ensemble du cycle de vie (due diligence, contractualisation, suivi de performance, plans de remÃ©diation) ?",
            en: "Does supplier risk management cover the entire lifecycle (due diligence, contracting, performance monitoring, remediation plans)?",
          },
        },
        {
          id: "PR-DS.04",
          function: "PROTECT",
          category: "Data Security",
          text: {
            fr: "Les donnÃ©es sensibles sont-elles identifiÃ©es, classifiÃ©es et protÃ©gÃ©es (chiffrement, DLP, masquage, gouvernance dâ€™accÃ¨s) ?",
            en: "Are sensitive data identified, classified, and protected (encryption, DLP, masking, access governance)?",
          },
        },
        {
          id: "PR-PT.03",
          function: "PROTECT",
          category: "Protective Technology",
          text: {
            fr: "Les configurations de sÃ©curitÃ© (bastion, durcissement, patching) sont-elles gÃ©rÃ©es et auditÃ©es rÃ©guliÃ¨rement sur tous les environnements ?",
            en: "Are security configurations (hardening, patching, baseline) managed and audited regularly across all environments?",
          },
        },
        {
          id: "DE.AE-01",
          function: "DETECT",
          category: "Anomalies & Events",
          text: {
            fr: "Les capacitÃ©s de dÃ©tection couvrent-elles les environnements critiques (SIEM, EDR/XDR, UEBA) avec des cas dâ€™usage alignÃ©s aux risques ?",
            en: "Do detection capabilities cover critical environments (SIEM, EDR/XDR, UEBA) with use cases aligned to risks?",
          },
        },
        {
          id: "RS.RP-01",
          function: "RESPOND",
          category: "Response Planning",
          text: {
            fr: "Disposez-vous de plans de rÃ©ponse aux incidents testÃ©s (table-top, simulations) couvrant les scÃ©narios critiques (ransomware, fuite de donnÃ©es, compromission fournisseur) ?",
            en: "Do you have tested incident response plans (table-top, simulations) covering critical scenarios (ransomware, data breach, supplier compromise)?",
          },
        },
        {
          id: "RS.CO-02",
          function: "RESPOND",
          category: "Communications",
          text: {
            fr: "Les communications de crise cyber sont-elles prÃ©parÃ©es (messagerie, porte-paroles, obligations rÃ©glementaires, relations mÃ©dias et partenaires) ?",
            en: "Are cyber crisis communications prepared (messaging, spokespeople, regulatory obligations, media and partner relations)?",
          },
        },
        {
          id: "RC.IM-01",
          function: "RECOVER",
          category: "Improvements",
          text: {
            fr: "Les retours dâ€™expÃ©rience post-incident alimentent-ils lâ€™amÃ©lioration continue (revues, plans dâ€™actions, priorisation budgÃ©taire, partage avec les parties prenantes) ?",
            en: "Do post-incident lessons feed continuous improvement (reviews, action plans, budget prioritization, stakeholder sharing)?",
          },
        },
      ];

      const STORAGE_KEY = "nist-csf-20-app";

      function NistCsfQuestionnaire() {
        const [lang, setLang] = useState("fr");
        const [meta, setMeta] = useState({
          project: "",
          assessor: "",
          organization: "",
          assessmentDate: "",
        });
        const [answers, setAnswers] = useState(() => {
          try {
            if (typeof window === "undefined") return {};
            const saved = window.localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved).answers || {} : {};
          } catch (e) {
            return {};
          }
        });

        const [openInfo, setOpenInfo] = useState({});

        const [filter, setFilter] = useState({
          function: "ALL",
          category: "ALL",
          search: "",
        });

        const [targets, setTargets] = useState({
          GOVERN: 4,
          IDENTIFY: 4,
          PROTECT: 4,
          DETECT: 4,
          RESPOND: 4,
          RECOVER: 4,
        });

        const functions = useMemo(
          () => ["GOVERN", "IDENTIFY", "PROTECT", "DETECT", "RESPOND", "RECOVER"],
          []
        );
        const categories = useMemo(() => {
          const s = new Set(controls.map((c) => c.category));
          return ["ALL", ...Array.from(s).sort()];
        }, []);

        useEffect(() => {
          try {
            if (typeof window === "undefined") return;
            window.localStorage.setItem(
              STORAGE_KEY,
              JSON.stringify({ meta, answers, version: 1 })
            );
          } catch (e) {}
        }, [answers, meta]);

        const filteredControls = useMemo(() => {
          return controls.filter((c) => {
            const fOk = filter.function === "ALL" || c.function === filter.function;
            const catOk = filter.category === "ALL" || c.category === filter.category;
            const q = filter.search.trim().toLowerCase();
            const text =
              typeof c.text === "string"
                ? c.text
                : c.text?.[lang] || c.text?.fr || c.text?.en || "";
            const sOk =
              !q ||
              c.id.toLowerCase().includes(q) ||
              text.toLowerCase().includes(q) ||
              c.category.toLowerCase().includes(q) ||
              c.function.toLowerCase().includes(q);
            return fOk && catOk && sOk;
          });
        }, [filter, lang]);

        function updateAnswer(id, patch) {
          setAnswers((prev) => ({ ...prev, [id]: { ...prev[id], ...patch } }));
        }

        const progressByFunction = useMemo(() => {
          const map = {};
          for (const fn of functions) {
            const items = controls.filter((c) => c.function === fn);
            const answered = items.filter((i) => answers[i.id]?.score !== undefined)
              .length;
            map[fn] = { total: items.length, answered };
          }
          return map;
        }, [answers]);

        const functionScores = useMemo(() => {
          return functions.map((fn) => {
            const items = controls.filter((c) => c.function === fn);
            const vals = items
              .map((i) => answers[i.id]?.score)
              .filter((v) => v !== undefined);
            return { fn, score: Number(avg(vals).toFixed(2)), target: targets[fn] };
          });
        }, [answers, targets]);

        const categoryScores = useMemo(() => {
          const byCat = new Map();
          for (const c of controls) {
            const s = answers[c.id]?.score;
            if (typeof s !== "number") continue;
            if (!byCat.has(c.category)) byCat.set(c.category, []);
            byCat.get(c.category).push(s);
          }
          const rows = Array.from(byCat.entries()).map(([category, arr]) => ({
            category,
            score: Number(avg(arr).toFixed(2)),
          }));
          rows.sort((a, b) => b.score - a.score);
          return rows;
        }, [answers]);

        const overallMaturity = useMemo(() => {
          const vals = controls
            .map((c) => answers[c.id]?.score)
            .filter((v) => v !== undefined);
          return Number(avg(vals).toFixed(2));
        }, [answers]);

        const overall = useMemo(() => {
          const total = controls.length;
          const answered = controls.filter((i) => answers[i.id]?.score !== undefined)
            .length;
          return { total, answered };
        }, [answers]);

        function exportJSON() {
          const data = { meta, answers, controls };
          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `nist-csf20-assessment-${meta.organization || "org"}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }
        function getQuestionText(c) {
          if (typeof c.text === "string") return c.text;
          return c.text?.[lang] || c.text?.fr || c.text?.en || "";
        }
        function exportCSV() {
          const header = [
            "Function",
            "Category",
            "ID",
            "Question",
            "Score",
            "Comment",
            "Project",
            "Assessor",
            "Organization",
            "AssessmentDate",
            "Language",
          ];
          const rows = controls.map((c) => {
            const a = answers[c.id] || {};
            return [
              c.function,
              c.category,
              c.id,
              escapeCSV(getQuestionText(c)),
              a.score ?? "",
              escapeCSV(a.comment || ""),
              escapeCSV(meta.project || ""),
              escapeCSV(meta.assessor || ""),
              escapeCSV(meta.organization || ""),
              meta.assessmentDate || "",
              lang,
            ];
          });
          const csv = [header, ...rows]
            .map((r) => r.join(","))
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `nist-csf20-assessment-${meta.organization || "org"}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }
        function importJSON(evt) {
          const file = evt.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const data = JSON.parse(String(reader.result));
              if (data.meta) setMeta(data.meta);
              if (data.answers) setAnswers(data.answers);
              alert(lang === "fr" ? "Import rÃ©ussi." : "Import successful.");
            } catch (e) {
              alert(lang === "fr" ? "Fichier invalide." : "Invalid file.");
            }
          };
          reader.readAsText(file);
          evt.target.value = "";
        }

        const FlagToggle = () =>
          html`
            <button
              title=${t("globalToggleHint")}
              onClick=${() => setLang((p) => (p === "fr" ? "en" : "fr"))}
              class="text-xl md:text-2xl px-2 py-1 rounded-lg hover:bg-neutral-100"
              aria-label=${t("globalLang")}
            >
              ${lang === "fr" ? "ðŸ‡¬ðŸ‡§" : "ðŸ‡«ðŸ‡·"}
            </button>
          `;

        function t(key) {
          return I18N[lang][key] ?? key;
        }

        return html`
          <div class="min-h-screen bg-neutral-50 text-neutral-900">
            <div class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-neutral-200">
              <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
                <h1 class="text-xl md:text-2xl font-semibold">${t("appTitle")}</h1>
                <div class="flex items-center gap-2">
                  <${FlagToggle} />
                  <button onClick=${exportCSV} class="px-3 py-2 rounded-xl border hover:bg-neutral-100">
                    ${t("exportCSV")}
                  </button>
                  <button onClick=${exportJSON} class="px-3 py-2 rounded-xl border hover:bg-neutral-100">
                    ${t("exportJSON")}
                  </button>
                  <label class="px-3 py-2 rounded-xl border hover:bg-neutral-100 cursor-pointer">
                    ${t("importJSON")}
                    <input
                      type="file"
                      accept="application/json"
                      onChange=${importJSON}
                      class="hidden"
                    />
                  </label>
                </div>
              </div>
            </div>

            <div class="max-w-6xl mx-auto px-4 pt-4 pb-2 grid grid-cols-1 lg:grid-cols-12 gap-4">
              <div class="lg:col-span-3 rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm flex flex-col items-center justify-center">
                <div class="text-sm text-neutral-500">${t("maturityScore")}</div>
                <div class="text-5xl font-semibold mt-1">${overallMaturity.toFixed(1)}</div>
                <div class="text-xs text-neutral-500 mt-2">${t("maturityAvgHint")}</div>
              </div>
              <div class="lg:col-span-4 rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm">
                <div class="font-medium mb-2">${t("maturityByFn")}</div>
                <div class="h-40">
                  <${ResponsiveContainer} width="100%" height="100%">
                    <${BarChart} data=${functionScores} margin=${{ top: 8, right: 8, left: 0, bottom: 0 }}>
                      <${CartesianGrid} strokeDasharray="3 3" />
                      <${XAxis} dataKey="fn" tick=${{ fontSize: 12 }} />
                      <${YAxis} domain=${[0, 5]} tick=${{ fontSize: 12 }} />
                      <${Tooltip} formatter=${(v) => Number(v).toFixed(2)} />
                      <${Legend} verticalAlign="bottom" height=${24} />
                      <${Bar}
                        dataKey="score"
                        name=${lang === "fr" ? "Actuel" : "Current"}
                        radius=${[6, 6, 0, 0]}
                      >
                        ${functionScores.map(
                          (row) =>
                            html`<${Cell} key=${`${row.fn}-act`} fill=${functionColor(row.fn)} />`
                        )}
                      <//>
                      ${functionScores.map(
                        (row) =>
                          html`<${ReferenceLine}
                            key=${`${row.fn}-target-line`}
                            x=${row.fn}
                            y=${row.target}
                            strokeDasharray="4 3"
                            stroke=${functionColor(row.fn)}
                          />`
                      )}
                    <//>
                  <//>
                </div>
              </div>
              <div class="lg:col-span-5 rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm">
                <div class="font-medium mb-2">${t("radarTitle")}</div>
                <div class="h-40">
                  <${ResponsiveContainer} width="100%" height="100%">
                    <${RChart} data=${functionScores} outerRadius="80%">
                      <${PolarGrid} />
                      <${PolarAngleAxis} dataKey="fn" tick=${html`<${AngleTick} />`} />
                      <${PolarRadiusAxis} angle=${30} domain=${[0, 5]} />
                      <${RadarShape}
                        name=${lang === "fr" ? "Actuel" : "Current"}
                        dataKey="score"
                        stroke="#2563EB"
                        fill="#3B82F6"
                        fillOpacity=${0.4}
                      />
                      <${RadarShape}
                        name=${t("targetLegend")}
                        dataKey="target"
                        strokeDasharray="4 3"
                        stroke="#F97316"
                        fill="#FBBF24"
                        fillOpacity=${0.2}
                      />
                      <${Legend} verticalAlign="top" height=${24} />
                    <//>
                  <//>
                </div>
              </div>
              <div class="lg:col-span-12 rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm">
                <div class="font-medium mb-2">${t("catTitle")}</div>
                <div class="grid gap-2">
                  ${categoryScores.slice(0, 12).map((row) => {
                    const color = categoryColor(row.category);
                    return html`
                      <div class="grid grid-cols-12 items-center gap-3" key=${row.category}>
                        <div class="col-span-9 truncate text-sm flex items-center gap-2" title=${row.category}>
                          <span class="inline-block w-2.5 h-2.5 rounded-full" style=${{ backgroundColor: color }}></span>
                          <span>${row.category}</span>
                        </div>
                        <div class="col-span-2 h-2 rounded-full bg-neutral-200">
                          <div
                            class="h-2 rounded-full"
                            style=${{ width: `${(row.score / 5) * 100}%`, backgroundColor: color }}
                          ></div>
                        </div>
                        <div class="col-span-1 text-right text-sm tabular-nums">
                          ${row.score.toFixed(2)}
                        </div>
                      </div>
                    `;
                  })}
                  ${
                    !categoryScores.length &&
                    html`<div class="text-sm text-neutral-500">${t("noDataYet")}</div>`
                  }
                </div>
              </div>
            </div>

            <div class="max-w-6xl mx-auto px-4 py-4 grid md:grid-cols-2 gap-4">
              <${Card} title=${t("meta")}>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <${TextField}
                    label=${t("project")}
                    value=${meta.project}
                    onChange=${(v) => setMeta({ ...meta, project: v })}
                  />
                  <${TextField}
                    label=${t("assessor")}
                    value=${meta.assessor}
                    onChange=${(v) => setMeta({ ...meta, assessor: v })}
                  />
                  <${TextField}
                    label=${t("org")}
                    value=${meta.organization}
                    onChange=${(v) => setMeta({ ...meta, organization: v })}
                  />
                  <${TextField}
                    label=${t("date")}
                    type="date"
                    value=${meta.assessmentDate}
                    onChange=${(v) => setMeta({ ...meta, assessmentDate: v })}
                  />
                </div>
              <//>
              <${Card} title=${t("quickFilter")}>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <${Select}
                    label=${t("fnLabel")}
                    value=${filter.function}
                    onChange=${(v) => setFilter({ ...filter, function: v })}
                    options=${["ALL", ...functions]}
                  />
                  <${Select}
                    label=${t("catLabel")}
                    value=${filter.category}
                    onChange=${(v) => setFilter({ ...filter, category: v })}
                    options=${categories}
                  />
                </div>
                <div class="mt-3 flex flex-wrap gap-2">
                  ${functions.map(
                    (fn) => html`<${ProgressPill}
                      key=${fn}
                      label=${fn}
                      done=${progressByFunction[fn]?.answered || 0}
                      total=${progressByFunction[fn]?.total || 0}
                      onClick=${() => setFilter({ ...filter, function: fn })}
                    />`
                  )}
                  <${ProgressPill}
                    label="GLOBAL"
                    done=${overall.answered}
                    total=${overall.total}
                    onClick=${() => setFilter({ ...filter, function: "ALL" })}
                  />
                </div>
              <//>
            </div>

            <div class="max-w-6xl mx-auto px-4 pt-0 pb-2">
              <${TextField}
                label=${t("search")}
                placeholder=${t("searchPh")}
                value=${filter.search}
                onChange=${(v) => setFilter({ ...filter, search: v })}
              />
            </div>

            <div class="max-w-6xl mx-auto px-4 pb-2">
              <${Card} title=${t("targets")}>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3">
                  ${functions.map(
                    (fn) => html`<label key=${fn} class="text-sm text-neutral-700">
                      <span class="block text-xs text-neutral-500 mb-1">${fn}</span>
                      <input
                        type="number"
                        min=${0}
                        max=${5}
                        step=${0.1}
                        value=${targets[fn]}
                        onChange=${(e) =>
                          setTargets({
                            ...targets,
                            [fn]: Math.max(0, Math.min(5, Number(e.target.value))),
                          })
                        }
                        class="w-full px-3 py-2 rounded-xl border border-neutral-300"
                      />
                    </label>`
                  )}
                </div>
              <//>
            </div>

            <div class="max-w-6xl mx-auto px-4 pb-10">
              <${SectionHeader}
                title=${t("questions")}
                subtitle=${`${t("display")}: ${filteredControls.length} / ${controls.length}`}
              />

              <div class="mb-4 overflow-x-auto">
                <div class="inline-flex gap-2 py-1">
                  ${["ALL", ...functions].map((key) => {
                    const isAll = key === "ALL";
                    const active = filter.function === (isAll ? "ALL" : key);
                    const baseColor = isAll ? "#6B7280" : functionColor(key);
                    const label = isAll
                      ? lang === "fr"
                        ? "Toutes les fonctions"
                        : "All functions"
                      : getFunctionLabel(key, lang);
                    return html`
                      <button
                        key=${key}
                        onClick=${() =>
                          setFilter({
                            ...filter,
                            function: isAll ? "ALL" : key,
                          })
                        }
                        class="px-4 py-2 rounded-xl text-sm font-medium border whitespace-nowrap transition-colors"
                        style=${{
                          backgroundColor: active ? baseColor : "transparent",
                          color: active ? "#FFFFFF" : baseColor,
                          borderColor: baseColor,
                        }}
                      >
                        ${label}
                      </button>
                    `;
                  })}
                </div>
              </div>

              <div class="grid gap-4">
                ${filteredControls.map((q) => {
                  const a = answers[q.id] || {};
                  const color = categoryColor(q.category);
                  const qText = getQuestionText(q);
                  const hasDetails = Boolean(detailsById[q.id]);
                  const d = detailsById[q.id]?.[lang];
                  return html`
                    <div
                      key=${q.id}
                      class="rounded-2xl border border-neutral-200 bg-white p-4 shadow-sm"
                      style=${{ borderLeftWidth: 6, borderLeftColor: color }}
                    >
                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                          <div class="text-xs uppercase tracking-wide text-neutral-500 flex items-center gap-2">
                            <span class="inline-block w-2.5 h-2.5 rounded-full" style=${{ backgroundColor: color }}></span>
                            ${q.function} Â· ${q.category}
                          </div>
                          <div class="mt-0.5 font-medium break-words">
                            ${q.id} â€” ${qText}
                          </div>
                        </div>
                        <div class="shrink-0 flex items-center gap-2">
                          ${
                            hasDetails &&
                            html`<button
                              onClick=${() =>
                                setOpenInfo((prev) => ({
                                  ...prev,
                                  [q.id]: !prev[q.id],
                                }))
                              }
                              class="w-7 h-7 rounded-full border border-neutral-300 text-neutral-600 hover:bg-neutral-100 flex items-center justify-center"
                              title=${t("moreInfo")}
                              aria-label=${t("moreInfo")}
                            >
                              i
                            </button>`
                          }
                          <select
                            class="px-3 py-2 rounded-xl border border-neutral-300 bg-white"
                            value=${a.score ?? ""}
                            onChange=${(e) =>
                              updateAnswer(q.id, {
                                score:
                                  e.target.value === ""
                                    ? undefined
                                    : Number(e.target.value),
                              })
                            }
                          >
                            <option value="">${t("cmmiPlaceholder")}</option>
                            ${CMMI_SCALE.map(
                              (opt) => html`<option key=${opt.value} value=${opt.value}>
                                ${opt.label}
                              </option>`
                            )}
                          </select>
                        </div>
                      </div>

                      ${
                        hasDetails &&
                        openInfo[q.id] &&
                        d &&
                        html`<div class="mt-3 rounded-xl border border-neutral-200 p-3 bg-neutral-50">
                          <div class="grid md:grid-cols-2 gap-3">
                            <div class="md:col-span-2">
                              <div class="text-sm font-medium mb-1">${t("descFull")}</div>
                              <p class="text-sm text-neutral-700">${d.desc}</p>
                            </div>
                            <div>
                              <div class="text-sm font-medium mb-1">${t("people")}</div>
                              <ul class="list-disc pl-5 text-sm text-neutral-700">
                                ${d.people.map((it, idx) => html`<li key=${idx}>${it}</li>`)}
                              </ul>
                            </div>
                            <div>
                              <div class="text-sm font-medium mb-1">${t("process")}</div>
                              <ul class="list-disc pl-5 text-sm text-neutral-700">
                                ${d.process.map((it, idx) => html`<li key=${idx}>${it}</li>`)}
                              </ul>
                            </div>
                            <div class="md:col-span-2">
                              <div class="text-sm font-medium mb-1">${t("technology")}</div>
                              <div class="flex flex-wrap gap-2">
                                ${d.tech.map(
                                  (it, idx) =>
                                    html`<span
                                      key=${idx}
                                      class="px-2 py-1 rounded-full border border-neutral-300 bg-white text-xs"
                                    >
                                      ${it}
                                    </span>`
                                )}
                              </div>
                            </div>
                          </div>
                        </div>`
                      }

                      <div class="mt-3">
                        <textarea
                          class="w-full min-h-[88px] rounded-xl border border-neutral-300 p-3"
                          placeholder=${t("commentsPh")}
                          value=${a.comment || ""}
                          onChange=${(e) =>
                            updateAnswer(q.id, { comment: e.target.value })
                          }
                        ></textarea>
                      </div>
                    </div>
                  `;
                })}
              </div>
            </div>

            <div class="max-w-6xl mx-auto px-4 pb-16 text-sm text-neutral-600">
              <p class="mb-1">${t("tips1")}</p>
              <p class="mb-1">${t("tips2")}</p>
              <p>${t("tips3")}</p>
            </div>
          </div>
        `;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(html`<${NistCsfQuestionnaire} />`);
    </script>
  </body>
</html>
