<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NIST CSF 2.0 â€“ Questionnaire</title>

    <!-- Tailwind -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
    </style>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- PropTypes requis par Recharts 1.x -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts@1.6.2/umd/Recharts.min.js"></script>

    <!-- htm (JSX-like sans build) -->
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  </head>

  <body class="bg-neutral-50">
    <div id="root"></div>

    <script>
      const { useState, useEffect, useMemo } = React;
      const html = window.htm.bind(React.createElement);

      const {
        BarChart,
        Bar,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ResponsiveContainer,
        Radar: RadarShape,
        RadarChart: RChart,
        PolarGrid,
        PolarAngleAxis,
        PolarRadiusAxis,
        Legend,
      } = Recharts;

      // ------------------ DonnÃ©es de base ------------------

      const FUNCTIONS = [
        { id: "GOVERN", fr: "Gouverner", en: "Govern" },
        { id: "IDENTIFY", fr: "Identifier", en: "Identify" },
        { id: "PROTECT", fr: "ProtÃ©ger", en: "Protect" },
        { id: "DETECT", fr: "DÃ©tecter", en: "Detect" },
        { id: "RESPOND", fr: "RÃ©pondre", en: "Respond" },
        { id: "RECOVER", fr: "RÃ©tablir", en: "Recover" },
      ];

      const QUESTIONS = [
        {
          id: "GV-01",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "La direction dÃ©finit-elle des objectifs clairs pour la cybersÃ©curitÃ© alignÃ©s sur la stratÃ©gie dâ€™affaires ?",
          en: "Does management define clear cybersecurity objectives aligned with business strategy?",
        },
        {
          id: "GV-02",
          fn: "GOVERN",
          category: "GV.RM",
          fr: "Un cadre de gestion des risques cyber est-il approuvÃ© et appliquÃ© ?",
          en: "Is a cybersecurity risk management framework approved and applied?",
        },
        {
          id: "ID-01",
          fn: "IDENTIFY",
          category: "ID.AM",
          fr: "Les actifs critiques (applications, donnÃ©es, infrastructures) sont-ils inventoriÃ©s et classifiÃ©s ?",
          en: "Are critical assets (applications, data, infrastructure) inventoried and classified?",
        },
        {
          id: "ID-02",
          fn: "IDENTIFY",
          category: "ID.RA",
          fr: "Des Ã©valuations de risques cyber sont-elles rÃ©alisÃ©es rÃ©guliÃ¨rement ?",
          en: "Are cyber risk assessments performed regularly?",
        },
        {
          id: "PR-01",
          fn: "PROTECT",
          category: "PR.AC",
          fr: "Les accÃ¨s sont-ils gÃ©rÃ©s selon le principe du moindre privilÃ¨ge ?",
          en: "Are accesses managed according to the least privilege principle?",
        },
        {
          id: "PR-02",
          fn: "PROTECT",
          category: "PR.IP",
          fr: "Des procÃ©dures formelles existent-elles pour la gestion des changements ?",
          en: "Are formal procedures in place for change management?",
        },
        {
          id: "DE-01",
          fn: "DETECT",
          category: "DE.CM",
          fr: "Un SOC ou une capacitÃ© de surveillance des journaux est-il en place ?",
          en: "Is a SOC or log monitoring capability in place?",
        },
        {
          id: "RS-01",
          fn: "RESPOND",
          category: "RS.MI",
          fr: "Des plans de rÃ©ponse aux incidents sont-ils dÃ©finis et testÃ©s ?",
          en: "Are incident response plans defined and tested?",
        },
        {
          id: "RC-01",
          fn: "RECOVER",
          category: "RC.RP",
          fr: "Des plans de reprise des activitÃ©s sont-ils documentÃ©s et testÃ©s ?",
          en: "Are business recovery plans documented and tested?",
        },
      ];

      const CATEGORY_GROUPS = FUNCTIONS.map((fn) => {
        const categories = [
          ...new Set(
            QUESTIONS.filter((q) => q.fn === fn.id).map((q) => q.category)
          ),
        ];
        return { ...fn, categories };
      }).filter((group) => group.categories.length > 0);

      const FUNCTION_COLORS = {
        GOVERN: "#1E3A8A",
        IDENTIFY: "#2563EB",
        PROTECT: "#059669",
        DETECT: "#9333EA",
        RESPOND: "#DC2626",
        RECOVER: "#EA580C",
      };

      const I18N = {
        fr: {
          appTitle: "NIST CSF 2.0 â€“ Questionnaire dâ€™Ã©valuation",
          meta: "MÃ©tadonnÃ©es",
          project: "Projet",
          assessor: "Ã‰valuateur",
          org: "Organisation",
          date: "Date",
          globalLang: "Langue",
          maturityScore: "Score de maturitÃ©",
          maturityByFn: "MaturitÃ© par Function",
          radarTitle: "Actuel vs Cible (par Function)",
          noDataYet:
            "Aucune donnÃ©e encore â€” commence Ã  noter des questions pour alimenter le dashboard.",
          questions: "Questions",
          score: "Score",
          target: "Cible",
          comments: "Commentaires",
          searchPh: "Filtre (ID, texte, fonction...)",
          allFunctions: "Toutes les fonctions",
          filterByFunction: "Fonctions",
          tips1: "ðŸ’¾ Sauvegarde automatique (localStorage du navigateur).",
          tips2:
            "ðŸ“¤ Export possible en copiant les donnÃ©es de la console (JSON) si besoin.",
          cmmiInfo:
            "Notation suggÃ©rÃ©e : 0â€“5 (inexistant Ã  optimisÃ©) selon CMMI / NIST.",
        },
        en: {
          appTitle: "NIST CSF 2.0 â€“ Assessment Questionnaire",
          meta: "Metadata",
          project: "Project",
          assessor: "Assessor",
          org: "Organization",
          date: "Date",
          globalLang: "Language",
          maturityScore: "Maturity score",
          maturityByFn: "Maturity by Function",
          radarTitle: "Current vs Target (by Function)",
          noDataYet:
            "No data yet â€” start rating questions to feed the dashboard.",
          questions: "Questions",
          score: "Score",
          target: "Target",
          comments: "Comments",
          searchPh: "Filter (ID, text, function...)",
          allFunctions: "All functions",
          filterByFunction: "Functions",
          tips1: "ðŸ’¾ Autosave enabled (browser localStorage).",
          tips2:
            "ðŸ“¤ You can export data by copying JSON from the console if needed.",
          cmmiInfo:
            "Suggested rating: 0â€“5 (non-existent to optimized) based on CMMI / NIST.",
        },
      };

      // ------------------ Helpers ------------------

      function avg(values) {
        const nums = (values || []).filter(
          (v) => typeof v === "number" && !Number.isNaN(v)
        );
        if (!nums.length) return 0;
        return nums.reduce((a, b) => a + b, 0) / nums.length;
      }

      // ------------------ Composants UI ------------------

      function Card({ title, children }) {
        return html`
          <section className="bg-white rounded-2xl shadow-sm border border-neutral-200 p-4 md:p-6 mb-4">
            ${title &&
            html`<h2
              className="text-lg font-semibold text-neutral-900 mb-3 flex items-center gap-2"
            >
              ${title}
            </h2>`}
            ${children}
          </section>
        `;
      }

      function TextInput({ label, value, onChange, type = "text" }) {
        return html`
          <label className="block text-sm mb-2">
            <span className="text-neutral-700">${label}</span>
            <input
              className="mt-1 w-full rounded-lg border border-neutral-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              type=${type}
              value=${value || ""}
              onChange=${(e) => onChange(e.target.value)}
            />
          </label>
        `;
      }

      function SelectScore({ value, onChange }) {
        const options = [null, 0, 1, 2, 3, 4, 5];
        return html`
          <select
            className="w-full rounded-md border border-neutral-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            value=${value ?? ""}
            onChange=${(e) =>
              onChange(
                e.target.value === "" ? null : Number(e.target.value)
              )}
          >
            <option value="">â€“</option>
            ${options.map((v) =>
              v === null
                ? null
                : html`<option key=${v} value=${v}>${v}</option>`
            )}
          </select>
        `;
      }

      // ------------------ App principale ------------------

      function NistCsfQuestionnaire() {
        const [lang, setLang] = useState("fr");
        const t = I18N[lang];

        const [meta, setMeta] = useState({
          project: "",
          assessor: "",
          org: "",
          date: "",
        });

        const [answers, setAnswers] = useState({});
        const [search, setSearch] = useState("");
        const [functionFilter, setFunctionFilter] = useState("ALL");

        // ---- Chargement / sauvegarde locale ----

        useEffect(() => {
          try {
            const saved = JSON.parse(
              localStorage.getItem("nist-csf-questionnaire-v1") || "{}"
            );
            if (saved.meta) setMeta(saved.meta);
            if (saved.answers) setAnswers(saved.answers);
            if (saved.lang) setLang(saved.lang);
          } catch (e) {
            console.warn("No previous data", e);
          }
        }, []);

        useEffect(() => {
          const payload = { meta, answers, lang };
          localStorage.setItem(
            "nist-csf-questionnaire-v1",
            JSON.stringify(payload)
          );
        }, [meta, answers, lang]);

        const filteredQuestions = useMemo(() => {
          const s = search.toLowerCase();
          return QUESTIONS.filter((q) => {
            const matchesFunction =
              functionFilter === "ALL" || q.fn === functionFilter;
            if (!matchesFunction) return false;

            if (!s) return true;

            const text = (q[lang] || "").toLowerCase();
            return (
              q.id.toLowerCase().includes(s) ||
              q.category.toLowerCase().includes(s) ||
              text.includes(s)
            );
          });
        }, [search, lang, functionFilter]);

        const stats = useMemo(() => {
          const byFn = {};
          FUNCTIONS.forEach((fn) => {
            byFn[fn.id] = { scores: [], targets: [] };
          });

          QUESTIONS.forEach((q) => {
            const a = answers[q.id];
            if (!a) return;
            if (typeof a.score === "number")
              byFn[q.fn].scores.push(a.score);
            if (typeof a.target === "number")
              byFn[q.fn].targets.push(a.target);
          });

          const radarData = FUNCTIONS.map((fn) => ({
            function: fn[lang],
            current: avg(byFn[fn.id].scores),
            target: avg(byFn[fn.id].targets),
          }));

          const allScores = QUESTIONS.map((q) => answers[q.id]?.score);
          const global = avg(allScores);

          return { byFn, radarData, global };
        }, [answers, lang]);

        const hasData = stats.global > 0;

        return html`
          <div className="min-h-screen bg-neutral-50 py-6 px-3 md:px-6">
            <div className="max-w-6xl mx-auto">
              <header className="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold text-neutral-900">
                    ${t.appTitle}
                  </h1>
                  <p className="text-sm text-neutral-600 mt-1">
                    ${t.cmmiInfo}
                  </p>
                </div>
                <div className="flex items-center gap-2 self-start md:self-auto">
                  <span className="text-sm text-neutral-600">
                    ${t.globalLang}
                  </span>
                  <button
                    className="px-3 py-1 rounded-full border text-sm bg-white border-neutral-300 hover:border-blue-500 hover:text-blue-600"
                    onClick=${() => setLang(lang === "fr" ? "en" : "fr")}
                  >
                    ${lang === "fr" ? "FR ðŸ‡«ðŸ‡·" : "EN ðŸ‡¬ðŸ‡§"}
                  </button>
                </div>
              </header>

              <!-- MÃ©tadonnÃ©es -->
              <${Card} title=${t.meta}>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                  <${TextInput}
                    label=${t.project}
                    value=${meta.project}
                    onChange=${(v) => setMeta({ ...meta, project: v })}
                  />
                  <${TextInput}
                    label=${t.assessor}
                    value=${meta.assessor}
                    onChange=${(v) => setMeta({ ...meta, assessor: v })}
                  />
                  <${TextInput}
                    label=${t.org}
                    value=${meta.org}
                    onChange=${(v) => setMeta({ ...meta, org: v })}
                  />
                  <${TextInput}
                    label=${t.date}
                    type="date"
                    value=${meta.date}
                    onChange=${(v) => setMeta({ ...meta, date: v })}
                  />
                </div>
              <//>

              <!-- Dashboard -->
              <${Card} title="Dashboard">
                ${hasData
                  ? html`
                      <div
                        className="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start"
                      >
                        <div className="space-y-3">
                          <div
                            className="rounded-xl bg-blue-50 border border-blue-100 p-4"
                          >
                            <div
                              className="text-xs uppercase font-semibold text-blue-600 tracking-wide"
                            >
                              ${t.maturityScore}
                            </div>
                            <div
                              className="mt-2 text-3xl font-bold text-blue-900"
                            >
                              ${stats.global.toFixed(2)}
                            </div>
                            <div className="mt-1 text-xs text-blue-900/70">
                              (0â€“5)
                            </div>
                          </div>

                          <div className="text-xs text-neutral-500 space-y-1">
                            <p>${t.tips1}</p>
                            <p>${t.tips2}</p>
                          </div>
                        </div>

                        <div className="lg:col-span-2 h-64">
                          <${ResponsiveContainer} width="100%" height="100%">
                            <${BarChart}
                              data=${FUNCTIONS.map((fn) => ({
                                name: fn[lang],
                                value: avg(
                                  stats.byFn[fn.id].scores || []
                                ),
                              }))}
                            >
                              <${CartesianGrid} strokeDasharray="3 3" />
                              <${XAxis} dataKey="name" />
                              <${YAxis} domain=${[0, 5]} />
                              <${Tooltip} />
                              <${Bar} dataKey="value" fill="#2563EB" />
                            <//>
                          <//>
                          <p className="mt-2 text-xs text-neutral-500">
                            ${t.maturityByFn}
                          </p>
                        </div>
                      </div>

                      <div className="mt-6 h-72">
                        <${ResponsiveContainer} width="100%" height="100%">
                          <${RChart} data=${stats.radarData}>
                            <${PolarGrid} />
                            <${PolarAngleAxis} dataKey="function" />
                            <${PolarRadiusAxis} domain=${[0, 5]} />
                            <${RadarShape}
                              name="Current"
                              dataKey="current"
                              fill="#2563EB"
                              fillOpacity=${0.4}
                              stroke="#2563EB"
                            />
                            <${RadarShape}
                              name="Target"
                              dataKey="target"
                              fill="#F97316"
                              fillOpacity=${0.2}
                              stroke="#F97316"
                              strokeDasharray="4 4"
                            />
                            <${Legend} />
                          <//>
                        <//>
                        <p className="mt-2 text-xs text-neutral-500">
                          ${t.radarTitle}
                        </p>
                      </div>
                    `
                  : html`
                      <p className="text-sm text-neutral-500">
                        ${t.noDataYet}
                      </p>
                    `}
              <//>

              <!-- Questions -->
              <${Card} title=${t.questions}>
                <div className="flex flex-col gap-4 mb-3">
                  <div>
                    <div className="text-xs font-semibold uppercase text-neutral-500 tracking-wide mb-2">
                      ${t.filterByFunction}
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-1 -mx-1 px-1">
                      <button
                        className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                        style=${{
                          backgroundColor:
                            functionFilter === "ALL" ? "#1F2937" : "white",
                          color: functionFilter === "ALL" ? "white" : "#374151",
                          borderColor:
                            functionFilter === "ALL" ? "#1F2937" : "#D1D5DB",
                        }}
                        onClick=${() => setFunctionFilter("ALL")}
                      >
                        ${t.allFunctions}
                      </button>
                      ${FUNCTIONS.map((fn) => {
                        const isActive = functionFilter === fn.id;
                        const activeStyles = {
                          backgroundColor: FUNCTION_COLORS[fn.id],
                          color: "white",
                          borderColor: FUNCTION_COLORS[fn.id],
                        };
                        const inactiveStyles = {
                          backgroundColor: FUNCTION_COLORS[fn.id] + "14",
                          color: FUNCTION_COLORS[fn.id],
                          borderColor: FUNCTION_COLORS[fn.id] + "40",
                        };
                        return html`
                          <button
                            key=${fn.id}
                            className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                            style=${isActive ? activeStyles : inactiveStyles}
                            title=${fn[lang]}
                            onClick=${() =>
                              setFunctionFilter((prev) =>
                                prev === fn.id ? "ALL" : fn.id
                              )}
                          >
                            <span className="font-semibold">${fn[lang]}</span>
                            <span className="ml-1 text-[11px] uppercase">${fn.id}</span>
                          </button>
                        `;
                      })}
                    </div>
                  </div>

                  <div>
                    <input
                      className="w-full md:w-80 rounded-lg border border-neutral-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder=${t.searchPh}
                      value=${search}
                      onChange=${(e) => setSearch(e.target.value)}
                    />
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm border-t border-neutral-200">
                    <thead className="bg-neutral-100 text-neutral-700">
                      <tr>
                        <th className="px-3 py-2 text-left">ID</th>
                        <th className="px-3 py-2 text-left">Function</th>
                        <th className="px-3 py-2 text-left">Cat.</th>
                        <th className="px-3 py-2 text-left w-1/2">
                          ${t.questions}
                        </th>
                        <th className="px-3 py-2 text-left w-24">
                          ${t.score}
                        </th>
                        <th className="px-3 py-2 text-left w-24">
                          ${t.target}
                        </th>
                        <th className="px-3 py-2 text-left w-64">
                          ${t.comments}
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      ${filteredQuestions.map((q) => {
                        const fn = FUNCTIONS.find((f) => f.id === q.fn);
                        const a = answers[q.id] || {};
                        return html`
                          <tr
                            key=${q.id}
                            className="border-t border-neutral-200 align-top"
                          >
                            <td className="px-3 py-2 font-mono text-xs text-neutral-600">
                              ${q.id}
                            </td>
                            <td className="px-3 py-2 text-xs font-semibold">
                              <span
                                className="px-2 py-1 rounded-full text-[11px]"
                                style=${{
                                  backgroundColor:
                                    FUNCTION_COLORS[q.fn] + "20",
                                  color: FUNCTION_COLORS[q.fn],
                                }}
                              >
                                ${fn ? fn[lang] : q.fn}
                              </span>
                            </td>
                            <td className="px-3 py-2 text-xs text-neutral-600">
                              ${q.category}
                            </td>
                            <td className="px-3 py-2 text-neutral-800">
                              ${q[lang]}
                            </td>
                            <td className="px-3 py-2">
                              <${SelectScore}
                                value=${a.score}
                                onChange=${(v) =>
                                  setAnswers({
                                    ...answers,
                                    [q.id]: { ...a, score: v },
                                  })}
                              />
                            </td>
                            <td className="px-3 py-2">
                              <${SelectScore}
                                value=${a.target}
                                onChange=${(v) =>
                                  setAnswers({
                                    ...answers,
                                    [q.id]: { ...a, target: v },
                                  })}
                              />
                            </td>
                            <td className="px-3 py-2">
                              <textarea
                                className="w-full rounded-md border border-neutral-300 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                rows="2"
                                value=${a.comments || ""}
                                onChange=${(e) =>
                                  setAnswers({
                                    ...answers,
                                    [q.id]: {
                                      ...a,
                                      comments: e.target.value,
                                    },
                                  })}
                              ></textarea>
                            </td>
                          </tr>
                        `;
                      })}
                    </tbody>
                  </table>
                </div>
              <//>

              <p className="mt-4 text-xs text-neutral-400">
                ${t.tips1}
              </p>
            </div>
          </div>
        `;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(html`<${NistCsfQuestionnaire} />`);
    </script>
  </body>
</html>
