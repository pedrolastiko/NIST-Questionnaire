<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NIST CSF 2.0 â€“ Questionnaire</title>

    <!-- Tailwind -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
    </style>

    <!-- React & ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- PropTypes requis par Recharts 1.x -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts@1.6.2/umd/Recharts.min.js"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- htm (JSX-like sans build) -->
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
  </head>

  <body class="bg-neutral-50">
    <div id="root"></div>

    <script>
      const { useState, useEffect, useMemo, useCallback } = React;
      const html = window.htm.bind(React.createElement);

      const {
        BarChart,
        Bar,
        XAxis,
        YAxis,
        CartesianGrid,
        Tooltip,
        ResponsiveContainer,
        Radar: RadarShape,
        RadarChart: RChart,
        PolarGrid,
        PolarAngleAxis,
        PolarRadiusAxis,
        Legend,
        Cell,
      } = Recharts;

      // ------------------ DonnÃ©es de base ------------------

      const FUNCTIONS = [
        { id: "GOVERN", fr: "Gouverner", en: "Govern" },
        { id: "IDENTIFY", fr: "Identifier", en: "Identify" },
        { id: "PROTECT", fr: "ProtÃ©ger", en: "Protect" },
        { id: "DETECT", fr: "DÃ©tecter", en: "Detect" },
        { id: "RESPOND", fr: "RÃ©pondre", en: "Respond" },
        { id: "RECOVER", fr: "RÃ©tablir", en: "Recover" },
      ];

      const QUESTIONS = [
        {
          id: "GV.OC-01",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "La mission, les objectifs et les parties prenantes de lâ€™organisation sont-ils connus et utilisÃ©s pour guider les dÃ©cisions de gestion du risque cyber ?",
          en: "Are the organizationâ€™s mission, objectives, and stakeholders understood and used to guide cybersecurity risk management decisions?",
          detailFr:
            "Cette question vÃ©rifie que la direction cartographie la mission, les objectifs stratÃ©giques, les parties prenantes et les activitÃ©s critiques pour Ã©clairer les arbitrages de cybersÃ©curitÃ©. Informations complÃ©mentaires : rechercher des documents de planification stratÃ©gique, une cartographie des parties prenantes ou un registre dâ€™alignement cyber/business mis Ã  jour. Exemples dâ€™implÃ©mentation : ateliers rÃ©guliers entre la cybersÃ©curitÃ© et les mÃ©tiers pour rÃ©viser la mission, fiche de synthÃ¨se reliant objectifs dâ€™affaires et risques cyber, intÃ©gration dâ€™indicateurs cyber aux tableaux de bord de gouvernance.",
          detailEn:
            "This item confirms leadership maps the mission, strategic objectives, stakeholders, and critical activities so cybersecurity tradeoffs align with business priorities. Additional guidance: look for strategic plans, stakeholder maps, or an updated cybersecurity-to-business alignment register. Implementation examples: recurring workshops between security and business leaders, summary sheets tying business goals to cyber risks, and cybersecurity KPIs embedded in governance dashboards.",
        },
        {
          id: "GV.OC-02",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "Les rÃ´les dans lâ€™Ã©cosystÃ¨me (fournisseurs, partenaires, parties prenantes externes) et les dÃ©pendances associÃ©es sont-ils identifiÃ©s pour Ã©clairer les dÃ©cisions de cybersÃ©curitÃ© ?",
          en: "Are ecosystem roles (suppliers, partners, external stakeholders) and related dependencies identified to inform cybersecurity decisions?",
          detailFr:
            "Le contrÃ´le sâ€™assure que lâ€™organisation connaÃ®t les relations critiques de sa chaÃ®ne de valeur et les dÃ©pendances externes qui influencent la gestion du risque cyber. Informations complÃ©mentaires : vÃ©rifier la prÃ©sence dâ€™une cartographie des fournisseurs critiques, dâ€™accords de niveaux de service incluant des exigences cyber ou dâ€™analyses dâ€™impact supply chain. Exemples dâ€™implÃ©mentation : registre des tiers critiques avec Ã©valuations de maturitÃ©, clauses de cybersÃ©curitÃ© intÃ©grÃ©es aux contrats, comitÃ© de gouvernance supply chain/cyber se rÃ©unissant pÃ©riodiquement.",
          detailEn:
            "This control ensures the organization understands critical value-chain relationships and external dependencies that shape cybersecurity risk management. Additional guidance: check for critical supplier maps, service-level agreements with security clauses, or supply-chain impact analyses. Implementation examples: a critical third-party register with maturity reviews, cybersecurity provisions embedded in contracts, and a joint supply-chain/cybersecurity governance forum that meets regularly.",
        },
        {
          id: "GV.OC-03",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "Les exigences juridiques, rÃ©glementaires et contractuelles en matiÃ¨re de cybersÃ©curitÃ©, de protection des donnÃ©es et de confidentialitÃ© sont-elles connues et intÃ©grÃ©es dans la gestion des risques ?",
          en: "Are legal, regulatory, and contractual requirements for cybersecurity, data protection, and privacy understood and integrated into risk management?",
          detailFr:
            "Cette question confirme que lâ€™organisation recense et suit les obligations externes affectant la cybersÃ©curitÃ© pour orienter les contrÃ´les et prioritÃ©s. Informations complÃ©mentaires : consulter un registre de conformitÃ©, les rapports de veille rÃ©glementaire ou les matrices dâ€™obligations contractuelles. Exemples dâ€™implÃ©mentation : inventaire des textes applicables avec responsables nommÃ©s, processus de veille juridique partagÃ© avec la sÃ©curitÃ©, clauses de conformitÃ© cyber intÃ©grÃ©es dans les revues de risques.",
          detailEn:
            "This question confirms the organization catalogs and tracks external obligations impacting cybersecurity to steer controls and priorities. Additional guidance: look for compliance registers, regulatory watch reports, or matrices of contractual obligations. Implementation examples: inventory of applicable laws with assigned owners, a joint legal-security regulatory monitoring process, and cybersecurity compliance clauses embedded in risk reviews.",
        },
        {
          id: "GV.OC-04",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "Les services et capacitÃ©s critiques, ainsi que leurs dÃ©pendances, sont-ils identifiÃ©s et priorisÃ©s pour supporter la gestion du risque cyber ?",
          en: "Are critical services and capabilities, along with their dependencies, identified and prioritized to support cybersecurity risk management?",
          detailFr:
            "Le contrÃ´le vÃ©rifie que lâ€™organisation connaÃ®t les services essentiels et leurs dÃ©pendances technologiques ou opÃ©rationnelles pour cibler les efforts de protection. Informations complÃ©mentaires : analyser les analyses dâ€™impact sur lâ€™activitÃ© (BIA), les cartographies dâ€™architectures critiques ou les registres de dÃ©pendances. Exemples dâ€™implÃ©mentation : catalogue des services critiques avec niveaux de prioritÃ©, matrices reliant services, actifs et propriÃ©taires, ateliers de revue des dÃ©pendances avec les mÃ©tiers.",
          detailEn:
            "This control checks that the organization understands essential services and their technological or operational dependencies to target protection efforts. Additional guidance: review business impact analyses, critical architecture maps, or dependency registers. Implementation examples: catalogs of critical services with priority tiers, matrices linking services, assets, and owners, and business workshops to review dependencies.",
        },
        {
          id: "GV.OC-05",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "Des exigences de rÃ©silience sont-elles dÃ©finies pour soutenir la prestation des services critiques identifiÃ©s ?",
          en: "Are resilience requirements defined to support delivery of the identified critical services?",
          detailFr:
            "Cette question sâ€™assure que les niveaux de rÃ©silience attendus (RTO/RPO, tolÃ©rance aux pannes, scÃ©narios de continuitÃ©) sont Ã©tablis pour chaque service critique. Informations complÃ©mentaires : examiner les stratÃ©gies de continuitÃ©, les plans de reprise ou les objectifs de disponibilitÃ© approuvÃ©s. Exemples dâ€™implÃ©mentation : fiches de service dÃ©taillant RTO/RPO, tests rÃ©guliers de continuitÃ© vÃ©rifiant les seuils, intÃ©gration des exigences de rÃ©silience dans la gestion des changements et des contrats fournisseurs.",
          detailEn:
            "This question ensures expected resilience levels (RTO/RPO, fault tolerance, continuity scenarios) are defined for each critical service. Additional guidance: review continuity strategies, recovery plans, or approved availability objectives. Implementation examples: service profiles documenting RTO/RPO, regular continuity tests validating thresholds, and resilience requirements embedded in change management and supplier contracts.",
        },
        {
          id: "GV-01",
          fn: "GOVERN",
          category: "GV.OC",
          fr: "La direction dÃ©finit-elle des objectifs clairs pour la cybersÃ©curitÃ© alignÃ©s sur la stratÃ©gie dâ€™affaires ?",
          en: "Does management define clear cybersecurity objectives aligned with business strategy?",
          detailFr:
            "Cette question vÃ©rifie que le comitÃ© de direction formalise des orientations cybersÃ©curitÃ© mesurables et suivies, alignÃ©es sur les objectifs globaux de lâ€™organisation.",
          detailEn:
            "This control confirms leadership has documented, measurable cybersecurity objectives that stay aligned with broader business goals and receive regular oversight.",
        },
        {
          id: "GV-02",
          fn: "GOVERN",
          category: "GV.RM",
          fr: "Un cadre de gestion des risques cyber est-il approuvÃ© et appliquÃ© ?",
          en: "Is a cybersecurity risk management framework approved and applied?",
          detailFr:
            "Assurez-vous quâ€™un cadre de gestion des risques (ISO 27005, EBIOS, FAIR, etc.) est formellement adoptÃ©, communiquÃ© et utilisÃ© pour prioriser les actions.",
          detailEn:
            "Verify that a recognized risk management framework (ISO 27005, FAIR, EBIOS, etc.) is formally adopted, communicated, and used to prioritize mitigation efforts.",
        },
        {
          id: "ID-01",
          fn: "IDENTIFY",
          category: "ID.AM",
          fr: "Les actifs critiques (applications, donnÃ©es, infrastructures) sont-ils inventoriÃ©s et classifiÃ©s ?",
          en: "Are critical assets (applications, data, infrastructure) inventoried and classified?",
          detailFr:
            "Le contrÃ´le vise Ã  confirmer que tous les actifs critiques sont identifiÃ©s, catÃ©gorisÃ©s selon leur importance et mis Ã  jour pour soutenir les analyses de risques.",
          detailEn:
            "This control ensures critical assets are identified, categorized by importance, and maintained in an up-to-date repository to support risk assessments.",
        },
        {
          id: "ID-02",
          fn: "IDENTIFY",
          category: "ID.RA",
          fr: "Des Ã©valuations de risques cyber sont-elles rÃ©alisÃ©es rÃ©guliÃ¨rement ?",
          en: "Are cyber risk assessments performed regularly?",
          detailFr:
            "Il sâ€™agit de vÃ©rifier que des analyses de risques pÃ©riodiques Ã©valuent les menaces, vulnÃ©rabilitÃ©s et impacts, et quâ€™elles dÃ©bouchent sur des plans dâ€™actions.",
          detailEn:
            "Confirms that periodic risk assessments evaluate threats, vulnerabilities, and impacts, leading to actionable mitigation or treatment plans.",
        },
        {
          id: "PR-01",
          fn: "PROTECT",
          category: "PR.AC",
          fr: "Les accÃ¨s sont-ils gÃ©rÃ©s selon le principe du moindre privilÃ¨ge ?",
          en: "Are accesses managed according to the least privilege principle?",
          detailFr:
            "VÃ©rifiez que les droits dâ€™accÃ¨s sont accordÃ©s en fonction des rÃ´les, revus rÃ©guliÃ¨rement et rÃ©voquÃ©s dÃ¨s quâ€™ils ne sont plus nÃ©cessaires.",
          detailEn:
            "Ensure access rights are role-based, reviewed regularly, and revoked promptly when no longer required to enforce least privilege.",
        },
        {
          id: "PR-02",
          fn: "PROTECT",
          category: "PR.IP",
          fr: "Des procÃ©dures formelles existent-elles pour la gestion des changements ?",
          en: "Are formal procedures in place for change management?",
          detailFr:
            "La procÃ©dure de changement doit documenter les validations, tests, retours arriÃ¨re et responsabilitÃ©s afin de limiter les risques opÃ©rationnels.",
          detailEn:
            "Change processes should document approvals, testing, rollback plans, and ownership to limit operational and security risks.",
        },
        {
          id: "DE-01",
          fn: "DETECT",
          category: "DE.CM",
          fr: "Un SOC ou une capacitÃ© de surveillance des journaux est-il en place ?",
          en: "Is a SOC or log monitoring capability in place?",
          detailFr:
            "Le contrÃ´le valide lâ€™existence dâ€™une surveillance continue (SOC interne/externe) capable de dÃ©tecter rapidement des comportements anormaux.",
          detailEn:
            "This item confirms continuous monitoring is in placeâ€”internal or outsourced SOCâ€”to rapidly detect anomalous behaviors.",
        },
        {
          id: "RS-01",
          fn: "RESPOND",
          category: "RS.MI",
          fr: "Des plans de rÃ©ponse aux incidents sont-ils dÃ©finis et testÃ©s ?",
          en: "Are incident response plans defined and tested?",
          detailFr:
            "Les plans doivent couvrir les scÃ©narios majeurs, prÃ©ciser les rÃ´les et inclure des exercices rÃ©guliers pour vÃ©rifier lâ€™efficacitÃ© de la rÃ©ponse.",
          detailEn:
            "Plans should cover major scenarios, clarify responsibilities, and include rehearsals or tabletop exercises to prove response effectiveness.",
        },
        {
          id: "RC-01",
          fn: "RECOVER",
          category: "RC.RP",
          fr: "Des plans de reprise des activitÃ©s sont-ils documentÃ©s et testÃ©s ?",
          en: "Are business recovery plans documented and tested?",
          detailFr:
            "Ce contrÃ´le garantit la prÃ©sence de procÃ©dures de reprise documentÃ©es, testÃ©es et alignÃ©es sur les objectifs de continuitÃ© de lâ€™organisation.",
          detailEn:
            "Ensures recovery procedures are documented, tested, and aligned with organizational continuity objectives and recovery timeframes.",
        },
      ];

      const BASE_FUNCTION_CATEGORIES = {
        GOVERN: ["GV.OC", "GV.RM", "GV.RR", "GV.PO", "GV.OV", "GV.SC"],
        IDENTIFY: ["ID.AM", "ID.BE", "ID.IM", "ID.RA", "ID.RM", "ID.SC"],
        PROTECT: ["PR.AA", "PR.AT", "PR.DS", "PR.MA", "PR.PS", "PR.IR"],
        DETECT: ["DE.AE", "DE.CM", "DE.DP"],
        RESPOND: ["RS.RP", "RS.CO", "RS.AN", "RS.MI", "RS.IM", "RS.RR"],
        RECOVER: ["RC.RP", "RC.IM", "RC.CO"],
      };

      const FUNCTION_CATEGORIES = FUNCTIONS.reduce((acc, fn) => {
        const base = BASE_FUNCTION_CATEGORIES[fn.id] || [];
        const fromQuestions = QUESTIONS.filter((q) => q.fn === fn.id).map(
          (q) => q.category
        );
        const unique = Array.from(new Set([...base, ...fromQuestions]));
        acc[fn.id] = unique;
        return acc;
      }, {});

      const CATEGORY_TO_FUNCTION = Object.entries(FUNCTION_CATEGORIES).reduce(
        (map, [fnId, categories]) => {
          categories.forEach((category) => {
            map[category] = fnId;
          });
          return map;
        },
        {}
      );

      const ALL_CATEGORIES = FUNCTIONS.reduce((list, fn) => {
        (FUNCTION_CATEGORIES[fn.id] || []).forEach((category) => {
          if (!list.includes(category)) list.push(category);
        });
        return list;
      }, []);

      const DEFAULT_ANSWERS = QUESTIONS.reduce((acc, q) => {
        acc[q.id] = { target: 4 };
        return acc;
      }, {});

      function createDefaultAnswers() {
        const copy = {};
        QUESTIONS.forEach((q) => {
          copy[q.id] = { ...DEFAULT_ANSWERS[q.id] };
        });
        return copy;
      }

      const FUNCTION_COLORS = {
        GOVERN: "#1E3A8A",
        IDENTIFY: "#2563EB",
        PROTECT: "#059669",
        DETECT: "#9333EA",
        RESPOND: "#DC2626",
        RECOVER: "#EA580C",
      };

      const I18N = {
        fr: {
          appTitle: "NIST CSF 2.0 â€“ Questionnaire dâ€™Ã©valuation",
          meta: "MÃ©tadonnÃ©es",
          project: "Projet",
          assessor: "Ã‰valuateur",
          org: "Organisation",
          date: "Date",
          globalLang: "Langue",
          maturityScore: "Score de maturitÃ©",
          maturityTarget: "Score cible moyen",
          maturityByFn: "MaturitÃ© par Function",
          radarTitle: "Actuel vs Cible (par Function)",
          noDataYet:
            "Aucune donnÃ©e encore â€” commence Ã  noter des questions pour alimenter le dashboard.",
          questions: "Questions",
          score: "Score",
          target: "Cible",
          comments: "Commentaires",
          searchPh: "Filtre (ID, texte, fonction...)",
          allFunctions: "Toutes les fonctions",
          filterByFunction: "Fonctions",
          filterByCategory: "CatÃ©gories",
          allCategories: "Toutes les catÃ©gories",
          functionColumn: "Fonction",
          categoryColumn: "CatÃ©gorie",
          tips1: "ðŸ’¾ Sauvegarde automatique (localStorage du navigateur).",
          tips2:
            "ðŸ“¤ Utilisez les boutons dâ€™export pour rÃ©cupÃ©rer vos donnÃ©es (CSV ou PDF).",
          cmmiInfo:
            "Notation suggÃ©rÃ©e : 0â€“5 (inexistant Ã  optimisÃ©) selon CMMI / NIST.",
          targetInfo: "Objectif moyen saisi (0â€“5).",
          exportCsv: "Exporter en CSV",
          exportPdf: "Exporter en PDF",
          resetForm: "RÃ©initialiser",
          confirmReset:
            "Voulez-vous vraiment rÃ©initialiser le questionnaire ? Toutes les rÃ©ponses et mÃ©tadonnÃ©es seront effacÃ©es.",
          infoLabel: "Afficher les dÃ©tails du contrÃ´le",
        },
        en: {
          appTitle: "NIST CSF 2.0 â€“ Assessment Questionnaire",
          meta: "Metadata",
          project: "Project",
          assessor: "Assessor",
          org: "Organization",
          date: "Date",
          globalLang: "Language",
          maturityScore: "Maturity score",
          maturityTarget: "Average target score",
          maturityByFn: "Maturity by Function",
          radarTitle: "Current vs Target (by Function)",
          noDataYet:
            "No data yet â€” start rating questions to feed the dashboard.",
          questions: "Questions",
          score: "Score",
          target: "Target",
          comments: "Comments",
          searchPh: "Filter (ID, text, function...)",
          allFunctions: "All functions",
          filterByFunction: "Functions",
          filterByCategory: "Categories",
          allCategories: "All categories",
          functionColumn: "Function",
          categoryColumn: "Category",
          tips1: "ðŸ’¾ Autosave enabled (browser localStorage).",
          tips2:
            "ðŸ“¤ Use the export buttons to retrieve your data (CSV or PDF).",
          cmmiInfo:
            "Suggested rating: 0â€“5 (non-existent to optimized) based on CMMI / NIST.",
          targetInfo: "Average target set (0â€“5).",
          exportCsv: "Export to CSV",
          exportPdf: "Export to PDF",
          resetForm: "Reset",
          confirmReset:
            "Do you really want to reset the questionnaire? All answers and metadata will be cleared.",
          infoLabel: "Show control details",
        },
      };

      // ------------------ Helpers ------------------

      function avg(values) {
        const nums = (values || []).filter(
          (v) => typeof v === "number" && !Number.isNaN(v)
        );
        if (!nums.length) return 0;
        return nums.reduce((a, b) => a + b, 0) / nums.length;
      }

      // ------------------ Composants UI ------------------

      function Card({ title, children }) {
        return html`
          <section className="bg-white rounded-2xl shadow-sm border border-neutral-200 p-4 md:p-6 mb-4">
            ${title &&
            html`<h2
              className="text-lg font-semibold text-neutral-900 mb-3 flex items-center gap-2"
            >
              ${title}
            </h2>`}
            ${children}
          </section>
        `;
      }

      function TextInput({ label, value, onChange, type = "text" }) {
        return html`
          <label className="block text-sm mb-2">
            <span className="text-neutral-700">${label}</span>
            <input
              className="mt-1 w-full rounded-lg border border-neutral-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              type=${type}
              value=${value || ""}
              onChange=${(e) => onChange(e.target.value)}
            />
          </label>
        `;
      }

      function SelectScore({ value, onChange }) {
        const options = [null, 0, 1, 2, 3, 4, 5];
        return html`
          <select
            className="w-full rounded-md border border-neutral-300 px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            value=${value ?? ""}
            onChange=${(e) =>
              onChange(
                e.target.value === "" ? null : Number(e.target.value)
              )}
          >
            <option value="">â€“</option>
            ${options.map((v) =>
              v === null
                ? null
                : html`<option key=${v} value=${v}>${v}</option>`
            )}
          </select>
        `;
      }

      // ------------------ App principale ------------------

      function NistCsfQuestionnaire() {
        const [lang, setLang] = useState("fr");
        const t = I18N[lang];

        const [meta, setMeta] = useState({
          project: "",
          assessor: "",
          org: "",
          date: "",
        });

        const [answers, setAnswers] = useState(() => createDefaultAnswers());
        const [search, setSearch] = useState("");
        const [functionFilter, setFunctionFilter] = useState("ALL");
        const [selectedCategories, setSelectedCategories] = useState(
          () => [...ALL_CATEGORIES]
        );
        const [infoExpanded, setInfoExpanded] = useState({});

        // ---- Chargement / sauvegarde locale ----

        useEffect(() => {
          try {
            const saved = JSON.parse(
              localStorage.getItem("nist-csf-questionnaire-v1") || "{}"
            );
            if (saved.meta) setMeta(saved.meta);
            if (saved.answers) {
              const merged = createDefaultAnswers();
              Object.entries(saved.answers).forEach(([id, value]) => {
                merged[id] = {
                  ...merged[id],
                  ...value,
                };
              });
              setAnswers(merged);
            }
            if (saved.lang) setLang(saved.lang);
          } catch (e) {
            console.warn("No previous data", e);
          }
        }, []);

        useEffect(() => {
          const payload = { meta, answers, lang };
          localStorage.setItem(
            "nist-csf-questionnaire-v1",
            JSON.stringify(payload)
          );
        }, [meta, answers, lang]);

        const filteredQuestions = useMemo(() => {
          const s = search.toLowerCase();
          return QUESTIONS.filter((q) => {
            const matchesFunction =
              functionFilter === "ALL" || q.fn === functionFilter;
            if (!matchesFunction) return false;

            const matchesCategory =
              !selectedCategories.length ||
              selectedCategories.includes(q.category);
            if (!matchesCategory) return false;

            if (!s) return true;

            const text = (q[lang] || "").toLowerCase();
            return (
              q.id.toLowerCase().includes(s) ||
              q.category.toLowerCase().includes(s) ||
              text.includes(s)
            );
          });
        }, [search, lang, functionFilter, selectedCategories]);

        const stats = useMemo(() => {
          const byFn = {};
          FUNCTIONS.forEach((fn) => {
            byFn[fn.id] = { scores: [], targets: [] };
          });

          QUESTIONS.forEach((q) => {
            const a = answers[q.id];
            if (!a) return;
            if (typeof a.score === "number")
              byFn[q.fn].scores.push(a.score);
            if (typeof a.target === "number")
              byFn[q.fn].targets.push(a.target);
          });

          const radarData = FUNCTIONS.map((fn) => ({
            function: fn[lang],
            current: avg(byFn[fn.id].scores),
            target: avg(byFn[fn.id].targets),
          }));

          const allScores = QUESTIONS.map((q) => answers[q.id]?.score);
          const allTargets = QUESTIONS.map((q) => answers[q.id]?.target);
          const global = avg(allScores);
          const targetGlobal = avg(allTargets);

          return { byFn, radarData, global, targetGlobal };
        }, [answers, lang]);

        const hasScores = QUESTIONS.some(
          (q) => typeof answers[q.id]?.score === "number"
        );
        const hasTargets = QUESTIONS.some(
          (q) => typeof answers[q.id]?.target === "number"
        );
        const hasData = hasScores || hasTargets;

        const handleReset = useCallback(() => {
          if (!window.confirm(t.confirmReset)) return;

          setMeta({ project: "", assessor: "", org: "", date: "" });
          setAnswers(createDefaultAnswers());
          setSearch("");
          setFunctionFilter("ALL");
          setSelectedCategories([...ALL_CATEGORIES]);
          setInfoExpanded({});
        }, [t]);

        const handleToggleInfo = useCallback((id) => {
          setInfoExpanded((prev) => ({ ...prev, [id]: !prev[id] }));
        }, []);

        useEffect(() => {
          if (functionFilter === "ALL") {
            setSelectedCategories([...ALL_CATEGORIES]);
            return;
          }
          setSelectedCategories([
            ...(FUNCTION_CATEGORIES[functionFilter] || []),
          ]);
        }, [functionFilter]);

        const categoryOptions = useMemo(() => {
          if (functionFilter === "ALL") return ALL_CATEGORIES;
          return FUNCTION_CATEGORIES[functionFilter] || [];
        }, [functionFilter]);

        const handleCategoryClick = useCallback(
          (categoryId) => {
            setSelectedCategories((prev) => {
              if (prev.length === 1 && prev[0] === categoryId) {
                if (functionFilter === "ALL") {
                  return [...ALL_CATEGORIES];
                }
                return [...(FUNCTION_CATEGORIES[functionFilter] || [])];
              }
              return [categoryId];
            });
          },
          [functionFilter]
        );

        const resetCategoriesToDefault = useCallback(() => {
          if (functionFilter === "ALL") {
            setSelectedCategories([...ALL_CATEGORIES]);
            return;
          }
          setSelectedCategories([...(FUNCTION_CATEGORIES[functionFilter] || [])]);
        }, [functionFilter]);

        const handleExportCSV = useCallback(() => {
          const header = [
            "ID",
            t.functionColumn,
            t.categoryColumn,
            t.questions,
            t.score,
            t.target,
            t.comments,
          ];

          const csvRows = QUESTIONS.map((q) => {
            const fn = FUNCTIONS.find((f) => f.id === q.fn);
            const a = answers[q.id] || {};
            const clean = (value) =>
              (value ?? "")
                .toString()
                .replace(/"/g, '""')
                .replace(/\r?\n|\r/g, " ");

            return [
              q.id,
              fn ? fn[lang] : q.fn,
              q.category,
              q[lang],
              a.score ?? "",
              a.target ?? "",
              clean(a.comments || ""),
            ].map((value) => `"${clean(value)}"`).join(";");
          });

          const csvContent = [header.map((value) => `"${value}"`).join(";"), ...csvRows].join("\n");
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `nist-csf-questionnaire_${lang}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, [answers, lang, t]);

        const handleExportPDF = useCallback(() => {
          if (!window.jspdf || !window.jspdf.jsPDF) {
            console.warn("jsPDF unavailable");
            return;
          }

          const doc = new window.jspdf.jsPDF({
            orientation: "portrait",
            unit: "pt",
            format: "a4",
          });

          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();
          const margin = 40;
          let y = margin;

          doc.setFontSize(16);
          doc.text(t.appTitle, margin, y);
          y += 24;

          doc.setFontSize(10);
          const metaEntries = [
            [t.project, meta.project],
            [t.assessor, meta.assessor],
            [t.org, meta.org],
            [t.date, meta.date],
          ];

          metaEntries.forEach(([label, value]) => {
            doc.text(`${label}: ${value || "-"}`, margin, y);
            y += 14;
          });

          y += 10;

          const addPageIfNeeded = (spaceNeeded = 0) => {
            if (y + spaceNeeded <= pageHeight - margin) return;
            doc.addPage();
            y = margin;
          };

          QUESTIONS.forEach((q) => {
            const fn = FUNCTIONS.find((f) => f.id === q.fn);
            const a = answers[q.id] || {};

            addPageIfNeeded(80);

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text(`${q.id} â€“ ${fn ? fn[lang] : q.fn}`, margin, y);
            y += 16;

            doc.setFont("helvetica", "normal");
            const questionLines = doc.splitTextToSize(q[lang], pageWidth - margin * 2);
            doc.text(questionLines, margin, y);
            y += questionLines.length * 14;

            const details = [
              `${t.score}: ${typeof a.score === "number" ? a.score : "-"}`,
              `${t.target}: ${typeof a.target === "number" ? a.target : "-"}`,
              `${t.comments}: ${a.comments ? a.comments.replace(/\r?\n|\r/g, " ") : "-"}`,
            ];

            details.forEach((line) => {
              addPageIfNeeded(20);
              const wrapped = doc.splitTextToSize(line, pageWidth - margin * 2);
              doc.text(wrapped, margin, y);
              y += wrapped.length * 14;
            });

            y += 10;
          });

          doc.save(`nist-csf-questionnaire_${lang}.pdf`);
        }, [answers, lang, meta, t]);

        return html`
          <div className="min-h-screen bg-neutral-50 py-6 px-3 md:px-6">
            <div className="max-w-6xl mx-auto">
              <header className="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold text-neutral-900">
                    ${t.appTitle}
                  </h1>
                  <p className="text-sm text-neutral-600 mt-1">
                    ${t.cmmiInfo}
                  </p>
                </div>
                <div className="flex items-center gap-2 self-start md:self-auto">
                  <span className="text-sm text-neutral-600">
                    ${t.globalLang}
                  </span>
                  <button
                    className="px-3 py-1 rounded-full border text-sm bg-white border-neutral-300 hover:border-blue-500 hover:text-blue-600"
                    onClick=${() => setLang(lang === "fr" ? "en" : "fr")}
                  >
                    ${lang === "fr" ? "EN ðŸ‡¬ðŸ‡§" : "FR ðŸ‡«ðŸ‡·"}
                  </button>
                </div>
              </header>

              <!-- MÃ©tadonnÃ©es -->
              <${Card} title=${t.meta}>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                  <${TextInput}
                    label=${t.project}
                    value=${meta.project}
                    onChange=${(v) => setMeta({ ...meta, project: v })}
                  />
                  <${TextInput}
                    label=${t.assessor}
                    value=${meta.assessor}
                    onChange=${(v) => setMeta({ ...meta, assessor: v })}
                  />
                  <${TextInput}
                    label=${t.org}
                    value=${meta.org}
                    onChange=${(v) => setMeta({ ...meta, org: v })}
                  />
                  <${TextInput}
                    label=${t.date}
                    type="date"
                    value=${meta.date}
                    onChange=${(v) => setMeta({ ...meta, date: v })}
                  />
                </div>
              <//>

              <!-- Dashboard -->
              <${Card} title="Dashboard">
                ${hasData
                  ? html`
                      <div
                        className="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start"
                      >
                        <div className="space-y-3">
                          <div
                            className="rounded-xl bg-blue-50 border border-blue-100 p-4"
                          >
                            <div
                              className="text-xs uppercase font-semibold text-blue-600 tracking-wide"
                            >
                              ${t.maturityScore}
                            </div>
                            <div
                              className="mt-2 text-3xl font-bold text-blue-900"
                            >
                              ${stats.global.toFixed(2)}
                            </div>
                            <div className="mt-1 text-xs text-blue-900/70">
                              (0â€“5)
                            </div>
                            <div className="mt-4 pt-3 border-t border-blue-100">
                              <div
                                className="text-xs uppercase font-semibold text-blue-600 tracking-wide"
                              >
                                ${t.maturityTarget}
                              </div>
                              <div
                                className="mt-2 text-2xl font-semibold text-blue-900"
                              >
                                ${stats.targetGlobal.toFixed(2)}
                              </div>
                              <div className="mt-1 text-xs text-blue-900/70">
                                ${t.targetInfo}
                              </div>
                            </div>
                          </div>

                          <div className="text-xs text-neutral-500 space-y-1">
                            <p>${t.tips1}</p>
                            <p>${t.tips2}</p>
                          </div>
                        </div>

                        <div className="lg:col-span-2 h-64">
                          <${ResponsiveContainer} width="100%" height="100%">
                            <${BarChart}
                              data=${FUNCTIONS.map((fn) => ({
                                name: fn[lang],
                                value: avg(
                                  stats.byFn[fn.id].scores || []
                                ),
                                id: fn.id,
                              }))}
                            >
                              <${CartesianGrid} strokeDasharray="3 3" />
                              <${XAxis} dataKey="name" />
                              <${YAxis} domain=${[0, 5]} />
                              <${Tooltip} />
                              <${Bar} dataKey="value">
                                ${FUNCTIONS.map(
                                  (fn) =>
                                    html`<${Cell}
                                      key=${fn.id}
                                      fill=${FUNCTION_COLORS[fn.id]}
                                    />`
                                )}
                              <//>
                            <//>
                          <//>
                          <p className="mt-2 text-xs text-neutral-500">
                            ${t.maturityByFn}
                          </p>
                        </div>
                      </div>

                      <div className="mt-6 h-72">
                        <${ResponsiveContainer} width="100%" height="100%">
                          <${RChart} data=${stats.radarData}>
                            <${PolarGrid} />
                            <${PolarAngleAxis} dataKey="function" />
                            <${PolarRadiusAxis} domain=${[0, 5]} />
                            <${RadarShape}
                              name="Current"
                              dataKey="current"
                              fill="#2563EB"
                              fillOpacity=${0.4}
                              stroke="#2563EB"
                            />
                            <${RadarShape}
                              name="Target"
                              dataKey="target"
                              fill="#F97316"
                              fillOpacity=${0.2}
                              stroke="#F97316"
                              strokeDasharray="4 4"
                            />
                            <${Legend} />
                          <//>
                        <//>
                        <p className="mt-2 text-xs text-neutral-500">
                          ${t.radarTitle}
                        </p>
                      </div>
                    `
                  : html`
                      <p className="text-sm text-neutral-500">
                        ${t.noDataYet}
                      </p>
                    `}
              <//>

              <!-- Questions -->
              <${Card} title=${t.questions}>
                <div className="flex flex-col gap-4 mb-3">
                  <div>
                    <div className="text-xs font-semibold uppercase text-neutral-500 tracking-wide mb-2">
                      ${t.filterByFunction}
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-1 -mx-1 px-1">
                      <button
                        className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                        style=${{
                          backgroundColor:
                            functionFilter === "ALL" ? "#1F2937" : "white",
                          color: functionFilter === "ALL" ? "white" : "#374151",
                          borderColor:
                            functionFilter === "ALL" ? "#1F2937" : "#D1D5DB",
                        }}
                        onClick=${() => setFunctionFilter("ALL")}
                      >
                        ${t.allFunctions}
                      </button>
                      ${FUNCTIONS.map((fn) => {
                        const isActive = functionFilter === fn.id;
                        const activeStyles = {
                          backgroundColor: FUNCTION_COLORS[fn.id],
                          color: "white",
                          borderColor: FUNCTION_COLORS[fn.id],
                        };
                        const inactiveStyles = {
                          backgroundColor: FUNCTION_COLORS[fn.id] + "14",
                          color: FUNCTION_COLORS[fn.id],
                          borderColor: FUNCTION_COLORS[fn.id] + "40",
                        };
                        return html`
                          <button
                            key=${fn.id}
                            className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-semibold uppercase tracking-wide transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                            style=${isActive ? activeStyles : inactiveStyles}
                            title=${fn[lang]}
                            onClick=${() =>
                              setFunctionFilter((prev) =>
                                prev === fn.id ? "ALL" : fn.id
                              )}
                          >
                            ${(fn[lang] || fn.id).toUpperCase()}
                          </button>
                        `;
                      })}
                    </div>
                  </div>

                  <div>
                    <div className="text-xs font-semibold uppercase text-neutral-500 tracking-wide mb-2">
                      ${t.filterByCategory}
                    </div>
                    <div className="flex items-center gap-2 overflow-x-auto pb-1 -mx-1 px-1">
                      <button
                        className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-medium transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                        style=${{
                          backgroundColor: "#1F2937",
                          color: "white",
                          borderColor: "#1F2937",
                        }}
                        onClick=${resetCategoriesToDefault}
                        type="button"
                      >
                        ${t.allCategories}
                      </button>
                      ${categoryOptions.map((categoryId) => {
                        const fnId = CATEGORY_TO_FUNCTION[categoryId];
                        const baseColor = FUNCTION_COLORS[fnId] || "#1F2937";
                        const isActive = selectedCategories.includes(categoryId);
                        const activeStyles = {
                          backgroundColor: baseColor,
                          color: "white",
                          borderColor: baseColor,
                        };
                        const inactiveStyles = {
                          backgroundColor: baseColor + "14",
                          color: baseColor,
                          borderColor: baseColor + "40",
                        };
                        return html`
                          <button
                            key=${categoryId}
                            className="shrink-0 inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-semibold uppercase tracking-wide transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500"
                            style=${isActive ? activeStyles : inactiveStyles}
                            onClick=${() => handleCategoryClick(categoryId)}
                            type="button"
                          >
                            ${categoryId}
                          </button>
                        `;
                      })}
                    </div>
                  </div>

                  <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <input
                      className="w-full md:w-80 rounded-lg border border-neutral-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder=${t.searchPh}
                      value=${search}
                      onChange=${(e) => setSearch(e.target.value)}
                    />
                    <div className="flex items-center gap-2">
                      <button
                        className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-red-200 bg-white text-sm font-medium text-red-600 hover:border-red-400 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1"
                        onClick=${handleReset}
                        type="button"
                      >
                        ðŸ”„ ${t.resetForm}
                      </button>
                      <button
                        className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-neutral-300 bg-white text-sm font-medium text-neutral-700 hover:border-blue-500 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        onClick=${handleExportCSV}
                        type="button"
                      >
                        ðŸ“„ ${t.exportCsv}
                      </button>
                      <button
                        className="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-neutral-300 bg-white text-sm font-medium text-neutral-700 hover:border-blue-500 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        onClick=${handleExportPDF}
                        type="button"
                      >
                        ðŸ§¾ ${t.exportPdf}
                      </button>
                    </div>
                  </div>
                </div>

                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm border-t border-neutral-200">
                    <thead className="text-xs uppercase bg-neutral-100 text-neutral-700">
                      <tr>
                        <th className="px-3 py-2 text-left">${t.functionColumn}</th>
                        <th className="px-3 py-2 text-left">${t.categoryColumn}</th>
                        <th className="px-3 py-2 text-left">ID</th>
                        <th className="px-3 py-2 text-left">${lang === "fr" ? "Question" : "Question"}</th>
                        <th className="px-3 py-2 text-center w-16">
                          <span className="sr-only">${t.infoLabel}</span>
                        </th>
                        <th className="px-3 py-2 text-left w-24">${t.score}</th>
                        <th className="px-3 py-2 text-left w-24">${t.target}</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${filteredQuestions.map((q) => {
                        const fn = FUNCTIONS.find((f) => f.id === q.fn);
                        const a = answers[q.id] || {};
                        const detailText = lang === "fr" ? q.detailFr : q.detailEn;
                        const expanded = infoExpanded[q.id];
                        return html`
                          <${React.Fragment} key=${q.id}>
                            <tr className="border-t border-neutral-200 align-top">
                              <td className="px-3 py-3 text-xs font-semibold">
                                <span
                                  className="px-2 py-1 rounded-full text-[11px]"
                                  style=${{
                                    backgroundColor: FUNCTION_COLORS[q.fn] + "20",
                                    color: FUNCTION_COLORS[q.fn],
                                  }}
                                >
                                  ${fn ? fn[lang] : q.fn}
                                </span>
                              </td>
                              <td className="px-3 py-3 text-xs text-neutral-600">
                                ${q.category}
                              </td>
                              <td className="px-3 py-3 font-mono text-xs text-neutral-600">
                                ${q.id}
                              </td>
                              <td className="px-3 py-3 text-sm text-neutral-800">
                                <div>${q[lang]}</div>
                                ${detailText && expanded
                                  ? html`<p
                                      className="mt-2 rounded-lg border border-blue-100 bg-blue-50 px-3 py-2 text-xs text-blue-900"
                                    >
                                      ${detailText}
                                    </p>`
                                  : null}
                              </td>
                              <td className="px-3 py-3 text-center align-middle">
                                ${detailText
                                  ? html`<button
                                      type="button"
                                      className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-blue-200 bg-blue-50 text-xs font-semibold text-blue-700 hover:border-blue-300 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                      title=${t.infoLabel}
                                      aria-label=${t.infoLabel}
                                      aria-expanded=${expanded ? "true" : "false"}
                                      onClick=${() => handleToggleInfo(q.id)}
                                    >
                                      i
                                    </button>`
                                  : html`<span className="text-neutral-300">â€“</span>`}
                              </td>
                              <td className="px-3 py-3">
                                <${SelectScore}
                                  value=${a.score}
                                  onChange=${(v) =>
                                    setAnswers({
                                      ...answers,
                                      [q.id]: { ...a, score: v },
                                    })}
                                />
                              </td>
                              <td className="px-3 py-3">
                                <${SelectScore}
                                  value=${a.target}
                                  onChange=${(v) =>
                                    setAnswers({
                                      ...answers,
                                      [q.id]: { ...a, target: v },
                                    })}
                                />
                              </td>
                            </tr>
                            <tr className="border-b border-neutral-200">
                              <td className="px-3 pb-4 pt-0" colSpan="7">
                                <div className="flex flex-col gap-2">
                                  <div className="text-xs font-medium text-neutral-600">
                                    ${t.comments}
                                  </div>
                                  <textarea
                                    className="w-full rounded-md border border-neutral-300 px-2 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    rows="2"
                                    value=${a.comments || ""}
                                    onChange=${(e) =>
                                      setAnswers({
                                        ...answers,
                                        [q.id]: {
                                          ...a,
                                          comments: e.target.value,
                                        },
                                      })}
                                  ></textarea>
                                </div>
                              </td>
                            </tr>
                          <//>
                        `;
                      })}
                    </tbody>
                  </table>
                </div>
              <//>

              <p className="mt-4 text-xs text-neutral-400">
                ${t.tips1}
              </p>
            </div>
          </div>
        `;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(html`<${NistCsfQuestionnaire} />`);
    </script>
  </body>
</html>
